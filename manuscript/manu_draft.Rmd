---
title: "Assessment of the cumulative effects of restoration activities on water quality in Tampa Bay, Florida"
output: 
  bookdown::word_document2:
    reference_docx: my_styles.docx
bibliography: refs.bib
urlcolor: blue
link-citations: true
---

Marcus W. Beck ([marcusb@sccwrp.org](mailto:marcusb@sccwrp.org)), Southern California Coastal Water Research Project, Costa Mesa, CA

Edward T. Sherwood ([esherwood@tbep.org](mailto:esherwood@tbep.org)), Tampa Bay Estuary Program, Tampa, FL

Jessica Renee Henkel ([jessica.henkel@restorethegulf.gov](mailto:jessica.henkel@restorethegulf.gov)), Gulf Coast Ecosystem Restoration Council, New Orleans, LA

Kirsten Dorans ([kdorans@mail.harvard.edu](mailto:kdorans@mail.harvard.edu)), Tulane University, New Orleans, LA

Kathryn Ireland ([kathryn.b.ireland@gmail.com](mailto:kathryn.b.ireland@gmail.com)), Montana State University, Bozeman, MT

Patricia Varela ([varela_patricia@yahoo.com](mailto:varela_patricia@yahoo.com)), Geosyntec Consultants, Houston, TX

```{r echo = F}
# get current bib file
refs <- httr::GET('https://raw.githubusercontent.com/fawda123/refs/master/refs.bib')
refs <- rawToChar(refs$content)
writeLines(refs, con = file('refs.bib'))
```

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, cache = T, dev.args = list(family = 'serif'), out.width = '100%', cache.path = 'manu_draft_cache/')

# libraries
library(ggmap)
library(tidyverse)
library(geosphere)
library(stringi)
library(scales)
library(tibble)
library(vegan)
library(sf)
library(sp)
library(gridExtra)
library(ggrepel)
library(lubridate)
library(forcats)
library(Hmisc)
library(multcompView)
library(patchwork)
library(grid)
library(gridExtra)
library(flextable)
library(officer)

# functions
source('../R/funcs.R')
source('../R/get_chgdf.R')
source('../R/get_clo.R')
source('../R/get_dat.R')
source('../R/get_lik.R')

# # spatial match for figs
# mtch <- 10
# wqmtch <- get_clo(restdat, reststat, wqstat, resgrp = 'top', mtch = mtch)
# save(wqmtch, file = '../data/wqmtch.RData', compress = 'xz')

load(file = '../data/restdat.RData')
load(file = '../data/reststat.RData')
load(file = '../data/wqstat.RData')
load(file = '../data/wqdat.RData')
load(file = '../data/wqmtch.RData')
load(file = '../data/grdavemanu.RData')
load(file = '../data/tb_seg.RData')

# restoration project type levels, labels and colors
typelev <- c('hab_enh', 'hab_est', 'hab_pro', 'non_src', 'pnt_src')
typelab <- c('Habitat\nenhance', 'Habitat\nestablish', 'Habitat\nprotect', 'Nonpoint\ncontrol', 'Point\ncontrol')
typecol <- c('#31a354', '#74c476' , '#c7e9c0', '#3182bd', '#9ecae1')
```

```{r spellcheck, echo = F, cache = F, eval = F}
spelling::spell_check_files('manuscript/manu_draft.Rmd')
```

```{r echo = F, cache = F}
raw <- system('git log -1', intern = TRUE)
raw <- raw[grep('^Date', raw)]
raw <- paste('Version', raw)
```
`r raw`

# Abstract

Habitat and water quality restoration projects are commonly used to enhance coastal resources or mitigate negative impacts of water quality stressors.  Significant resources have been exended for restoration projects, yet much less attention has focused on evaluating the outcomes beyond site-specific assessments.  This study presents an empirical framework to evaluate multiple datasets in the Tampa Bay area (Florida, USA) to identify 1) types of restoration projects that produce the greatest improvements in water quality, and 2) which time frames for different projects are most relevant for having the largest perceived benefits.  Information on the location and date of completion for 887 restoration projects from 1971 to 2017 were spatially and temporally matched with water quality records at each of 45 long-term monitoring stations in Tampa Bay.  Estimates of chlorophyll concentrations before and after the completion of one to many projects were used to develop an expectation of water quality changes from investments in different restoration activities.  Water infrastructure projects to control point sources of nutrient loading into the bay were associated with the highest likelihood of chlorophyll reduction, particularly for projects occurring prior to 1995.  Habitat restoration projects were also associated with reductions in chlorophyll, although the likelihood of reductions from the cumulative effects of these projects were less than those from infrastructure improvements.  The framework is sufficiently flexible for application to different locations and could be used to develop reasonable expectations for future restoration projects along the Gulf of Mexico.

# Introduction

Despite considerable investments over the last four decades in coastal and estuarine ecosystem restoration [@Diefenderfer16], numerous challenges still impede comprehensive success. In the Gulf of Mexico (GOM), chronic and discrete drivers contribute to the difficulty in restoring and managing coastal ecosystems. For example, the synergistic effects of widespread chronic coastal urbanization and climate change impacts will likely limit future habitat management effectiveness [@Enwright16]. Competing management and policy directives for flood protection, national commerce and energy development complicate and prolong efforts to abate coastal hypoxia and other coastal water quality issues [@Rabotyagov14;@Alfredo17]. Disputes surrounding fair and equitable natural resource allocation often result in contentious implementation plans for the long-term sustainability of coastal resources (GMFMC 2017). And, discrete tropical storm [@Greening06b] and large-scale pollution events [@Beyer16] often reset, reverse or delay progress in restoring coastal ecosystems. These factors contribute to a complex setting for successful implementation of ecosystem restoration activities within the GOM.

Notwithstanding these challenges, the difficulty in rigorously monitoring and understanding an ecosystem’s condition and restoration trajectory at various spatial and temporal scales further constrain rigorous observations of restoration success [@Hobbs01]. The lack of long-term environmental monitoring is a primary impediment to understanding pre- versus post- restoration change [@Schiff16] -- while also impeding the recognition of any coastal ecosystem improvements derived from prolonged management, policy and restoration activities. Where long-term coastal monitoring programs have been implemented, a broader sense of how management, policy and restoration activities affect coastal ecosystem quality can be attained [@Borja16]. Utilizing lessons-learned from environmental monitoring programs, new frameworks are starting to emerge to better understand and facilitate the implementation of coastal restoration ecology from a more informed perspective [@Bayraktarov16;@Diefenderfer16].

A very large, comprehensive and concerted effort to restore Gulf of Mexico coastal ecosystems is currently underway (GCERC 2013, 2016). Primary funding for this effort stems from the legal settlements resulting from the 2010 Deepwater Horizon oil spill. Funding sources include: early restoration investments that were made immediately following the spill, resource damage assessments resulting from the spill’s impacts (NRDA, 2016), a record legal settlement of civil and criminal penalties negotiated between the responsible parties and the US government with strict US congressional oversight (RESTORE Act), and matching funds from research, monitoring and restoration practitioners worldwide. These funds, equating to >$20B US, present the Gulf of Mexico community an unprecedented opportunity to revitalize regional restoration efforts that will span multiple generations (GCERC 2013, 2016). Consequently, the restoration investments being made with these funds will be highly scrutinized. Better understanding the environmental outcomes of past restoration investments will help identify how, where and when future resources should be invested so that the Gulf Coast community can achieve the highest degree of restoration success.
 
Because of the difficulties in demonstrating restoration success, new tools are needed to help guide and support the implementation of GOM restoration activities. Here, we present an empirical framework for evaluating the influence of multiple restoration project types on water quality improvements within a GOM estuary. The framework helps synthesize routine, ambient monitoring data across various spatio-temporal scales to demonstrate how the cumulative effects of coastal restoration activities contribute towards broad estuarine water quality improvements. Data on water quality and restoration projects in the Tampa Bay area (Florida, USA) were used to demonstrate application of the analysis framework. Tampa Bay is the second largest estuarine embayment in the GOM and has been intensively monitored since the mid-1970s. The ecological context of water quality changes in the Bay is well-described [@Greening2014] and a comprehensive history of restoration projects occurring in the watershed is available, making Tampa Bay an ideal test case for demonstrating and applying a new evaluation framework. The water quality and restoration datasets were evaluated to identify: 1) the types of restoration activities that contribute to the greatest improvements in water quality, and 2) the time frames over which water quality benefits may be elucidated from synergistic restoration activities.  Changes in chlorophyll-a concentrations, a proxy for negative eutrophication effects within Tampa Bay [@Greening2014], were used as the success metric to evaluate estuarine restoration activities. 

# Methods

## Study area

Tampa Bay is located on the west-central GOM coast of the Florida peninsula, and its watershed is one of the most highly developed regions in Florida (Figure \@ref(fig:map)).  More than 60 percent of land within 15 km of the Bay shoreline is a mix of urban and suburban uses (SWFWMD 2011).  The Bay has been a focal point of economic activity since the 1950s and currently supports a mix of industrial, domestic, and recreational activities.  The watershed includes one of the largest phosphate production regions in the country, which is supported by port operations primarily in the northeast portion of the Bay [@Greening2014].  Water quality data have been collected since the 1970s when environmental conditions were highly degraded.  Nitrogen loads into the Bay in the mid-1970s have been estimated as 8.9 x 10^6 kg year-1, most of which came from untreated wastewater effluent [@Greening2014].  In addition to reduced aesthetics, hypereutrophic environmental conditions were common and included elevated chlorophyll-a concentrations, increased occurrence of harmful algal species, low concentrations of bottom water dissolved oxygen, low water clarity, reduced seagrass coverage, and reported declines in fishery yields for both sport and recreational species.  Advanced wastewater treatment operations were implemented at municipal plants by the early 1980s.  These efforts were successful in reducing nutrients loads to the Bay by as much as 90%. 
 
Current water quality in Tampa Bay is dramatically improved from historical conditions.  Most notably, seagrass coverage in 2016 was reported as 16,857 hectares baywide, surpassing the restoration goal of coverage in the 1950s [@Sherwood17].  These changes have occurred in parallel with reductions in nutrient loading [@Poe05;@Greening2014], chlorophyll concentrations [@Wang99;@Beck15], and improvements in water clarity [@Morrison06;@Beck17c]. Most of these positive changes have resulted from management efforts to reduce point source controls on nutrient pollution in the highly developed areas of Hillsborough Bay [@Johansson91;@Johansson92]. 

The cumulative and synergistic effects of nearly 900 additional management activities have also likely contributed to water quality improvements over the past 4 decades, yet no previous efforts have been made to quantify potential associations between these projects and water quality.  Several hundred projects from both public and private entities have been completed since the 1971.  These projects represent numerous voluntary (e.g., coastal habitat acquisition, restoration, preservation, etc.) and compliance-driven (e.g., stormwater retrofits, process water treatment upgrades, site-level permitting, power plant scrubber upgrades, improved agricultural practices, residential fertilizer use ordinances, etc.) activities. Although it is generally recognized that these projects have contributed to overall estuarine ecosystem improvements, their cumulative effects, relative to broad watershed-scale management efforts, are not well understood. Understanding how these projects affect adjacent estuarine water quality at various spatio-temporal scales will provide an improved understanding of the link between overall estuary improvements and specific restoration activities.
 
## Data sources

Several databases were synthesized to provide a comprehensive history of restoration projects that have occurred in Tampa Bay and its watershed.  The first dataset was obtained from the Tampa Bay Water Atlas (version 2.3, [http://maps.wateratlas.usf.edu/tampabay/](http://maps.wateratlas.usf.edu/tampabay/), @TBEP17) maintained as a joint resource by the University of South Florida, the Tampa Bay Estuary Program (TBEP), and partners.  This database included 253 projects from 1971 to 2007 that were primarily focused on habitat establishment, enhancement, or protection along the Bay's immediate shoreline or within the larger watershed area (e.g., restoration of salt marshes and mangroves, exotic vegetation control, conversion of agricultural lands to natural habitats, etc.). Information on more recent projects (2008-2017) acquired from the US EPA's National Estuary Program Mapper ([https://gispub2.epa.gov/NEPmap/](https://gispub2.epa.gov/NEPmap/)) included an additional 265 projects. This database was limited to basic information, such as year of completion, geographic coordinates, general activities, and areal coverage.  The last database was obtained from the TBEP Action Plan Database Portal ([https://apdb.tbeptech.org/index.php](https://apdb.tbeptech.org/index.php)) to describe locations of broader infrastructure improvement projects, structural best management practices, and policy-driven management actions. This database included 368 projects from 1992 to 2016 for county, municipal or industrial activities, such as implementation of best management practices at treatment plants, creation of stormwater retention or treatment controls, or site-specific controls of point sources. 

For all restoration datasets, shared information included the location, year of completion, and project classification of the restoration activity. Because the types of projects differed, a classification scheme was developed that first described projects broadly as habitat or water infrastructure improvements and secondarily as a lower-level classification for habitat projects: enhancement, establishment, and protection; and water infrastructure projects: nonpoint source or point source controls.  These categories were used to provide a broad characterization of restoration activities that were considered relevant for the perceived improvements in water quality over time. The five sub-categories (habitat enhancement, establishment, and protection; non-point and point source controls) were separately evaluated to describe the likelihood of changes in water quality associated with each type (described below).  The final combined dataset included `r nrow(restdat)` projects from 1971 to 2017 (Figure \@ref(fig:restyrs)).  Projects with incomplete information (i.e., missing date) were not included in the final dataset.
 
Water quality data in Tampa Bay have been consistently collected since 1974 by the Environmental Protection Commission of Hillsborough County [@Sherwood16;@TBEP17].  Data were collected monthly at forty-five stations using a water sample from mid-depth or a monitoring sonde depending on the parameter.  Monitoring stations are fixed and cover the entire bay from the uppermost mesohaline sections to the lowermost euhaline portions that have direct interaction with the GOM. Water samples at each station are laboratory processed immediately after collection.  Measurements at each site include temperature (^o^C), Secchi disk depth (m), dissolved oxygen (mg/L), conductivity ($\mu$Ohms/cm), pH, salinity (psu), turbidity (Nephalometric Turbidity Units), chlorophyll-a ($\mu$g/L), total nitrogen (mg/L), and total phosphorus (mg/L).  For the models, all measurements of salinity, total nitrogen, and chlorophyll were combined for a total of 515 monthly observations of each parameter at each station.

## Data synthesis and analysis framework

Combining the restoration and water quality datasets was a critical part of developing the analysis framework.  Each dataset described events or sampling activities with unique dates and locations and a simple synoptic pairing of restoration projects with water quality data was not possible. To address this challenge, observations in each dataset were spatially and temporally matched using an approach designed to maximize the potential of identifying a unique effect of the restoration projects on changes in water quality.  Water quality monitoring sites were matched to the closest selected restoration projects and changes in the water quality data were evaluated relative to the completion dates of the selected projects.  

The matching between the two datasets began with a spatial join where the Euclidean distances between each water quality station and each restoration project were quantified.  The spatial matches were used to create a ranking of project sites from each water quality station based on distance.  The distances were also grouped by the five restoration project types (i.e., habitat protection, nonpoint source control, etc.) such that the closest $n$ sites of a given project type could be identified for any water quality station (Figure \@ref(fig:spmtch)).  

For each spatial match, temporal matching between water quality stations and restoration projects was obtained by subsetting the water quality data within a time window before and after the completion date of each restoration project (Figure \@ref(fig:tmmtch)).  For the closest $n$ restoration sites for each of five project types, two summarized water quality estimates were obtained to quantify a before and after estimate of chlorophyll associated with each project.  Time windows that overlapped the start and end date of the water quality time series were discarded.  The final two estimates of the before and after effects of the five types of restoration projects at each water quality station were based on an average of the $n$ closest restoration sites, weighted inversely by distance from the monitoring station.

Change in water quality relative to each type of restoration project was estimated as:

\begin{equation}
\delta WQ = \frac{\sum_{i = 1}^{n} \hat{wq} \in win + proj_{i, dt}}{n \cdot dist_{i \in n}} - \frac{\sum_{i = 1}^{n} \hat{wq} \in proj_{i, dt} - win}{n \cdot dist_{i \in n}}
(\#eq:wqdif)
\end{equation}

where $\delta WQ$ was the difference between the after and before averages for each of $n$ spatially  matched restoration projects.  For each $i$ of $n$ projects ($proj$), the average water quality ($\hat{wq}$) within the window ($win$) either before ($proj_{i, dt} - win$) or after ($win + proj_{i, dt}$) the completion date ($dt$) for project $i$ was summed.  The summation of water quality before and after each project was then divided by the total number of $n$ matched projects, multiplied by the distance of the projects from a water quality station ($dist_{i \in n}$). This created a weighted average of the before-after effects of each project that was inversely related to the distance from a water quality station. A weighted average by distance was used based on the assumption that restoration projects farther from a water quality station will have a weaker association with potential changes in chlorophyll. The total change in water quality for a project type was simply the difference in weighted averages.  This process was repeated for every station and a graphical example of eqn. \@ref(eq:wqdif) is shown in Figure \@ref(fig:statex).

There are key assumptions made by the above approach regarding how the analysis was conducted and what information is obtained from the result.  First, our spatial-temporal matching of water quality data with restoration projects is strictly associative where the general assumption is that restoration projects will benefit water quality through a decrease in chlorophyll.  We make no assumptions about the expected magnitude of an association given that the model does not describe a mechanism of change.  However, a general expectation is that chlorophyll changes will be different by project type and this association will vary as a function of distance and evaluated time windows.  An expected outcome is that qualitative statements can be made about the relative differences between projects types, particularly regarding how more projects of a particular type could benefit water quality and within what general time windows a change might be expected.

An additional assumption is that the model was designed to describe cumulative effects at different spatial scales.  In eqn. \@ref(eq:wqdif), the association of a restoration type with chlorophyll is estimated for one water quality station, whereas estimates from several water quality stations can be combined to develop an overall description of a particular restoration type as it applies to an areal unit of interest.  For example, estimated associations of point source control projects with each water quality station in the bay can be combined to develop an overall narrative of how these projects could positively effect environmental change in the bay.  The examples in Figures \@ref(fig:spmtch), \@ref(fig:tmmtch), and \@ref(fig:statex) are focused on individual stations to demonstrate core principles of the approach.  Estimates across stations were evaluated to describe baywide effects of restoration project types and by individual bay segments that have specific management targets for chlorophyll concentration [Florida Statute 62-302.532, @Janicki99]. This approach was used given the uneven distribution of restoration projects in space and time relative to the known changes in water quality that has been documented in the different Bay segments [@Greening2014].

Finally, parameters in eqn. \@ref(eq:wqdif) affected the synthesis of the datasets which directly controlled the ability to characterize associations of each restoration project type with water quality changes, 1) $n$, the number of spatially-matched restoration projects used to average the cumulative effect of each project type, and 2) $win$, the time windows before and after a project completion date that were used to subset each water quality time series.  Identifying values that maximized the difference between before and after water quality measurements was necessary to quantify how many projects were most strongly associated with a change in water quality, the time within which a change is expected, and the magnitude of an expected change between project types. All analyses were conducted with the R statistical programming language [@RDCT18].

# Results

## Observed data

Observed water quality trends in Tampa Bay showed a long-term decrease in Chlorophyll-a over the forty-year record consistent with documented changes [@Wang99;@Greening2014;@Beck15] (Table \@ref(tab:statsum)).  Median concentrations were highest in the earlier period of record from 1977 to 1987 (median 13.40 $\mu$g/L at low salinity stations, 7.30 $\mu$g/L at high salinity stations).  Declines were consistent throughout the period of record with the largest reductions occurring during the first twenty years (34% decrease), followed by consistent but smaller reductions in concentrations later in the time series. A 34% decrease at low salinity stations and a 30% decrease at high salinity stations was observed between the periods of 1977-1987 to 1987-1997.  Seasonally, chlorophyll concentrations were highest in the late summer/early fall periods (median 13.80 $\mu$g/L at low salinity stations, 7.23 $\mu$g/L at high salinity stations, across all years).  Similarly, total nitrogen concentrations had similar trends as chlorophyll, although a consistent decline similar in magnitude was observed across all four decades [@Poe05;@Greening2014].  An exception for nitrogen was observed at high salinity stations where concentrations were relatively constant at approximately 0.55 mg/L from 1987 to 2007.  Seasonally, nitrogen peaked in the late summer/early fall period.

The consistent decline in chlorophyll concentrations were opposite to the observed trends in the number and types of restoration projects in the watershed.  As shown in Figure \@ref(fig:restyrs), less projects were observed early in the record, whereas a majority were completed after the year 2000.  For the entire record, 275 (31% of total) habitat enhancement, 259 (29%) habitat establishment, 45 (5%) habitat protection, 248 (28%) nonpoint source, and 60 (7%) point source control projects were observed.  Individual point source controls early in the record were those that occurred in the historically polluted upper Hillsborough Bay [@Johansson91;@Johansson92]. Prior to 1995, only 11 water infrastructure projects (three non-point control, eight point source controls) were found in the database, whereas 70 habitat projects were observed (50 habitat establishment, 20 habitat enhancement).  From 1995 and on, nearly ten times as many restoration projects were observed in the record (806 total) with notable increases in the number of nonpoint source controls (245) and habitat protection projects (45).   

## Relationships of restoration projects with water quality 

A simple comparison of water quality measurements versus the cumulative number of restoration projects over time showed a decrease in both total nitrogen and chlorophyll with additional restoration.  Figure \@ref(fig:cumprj) shows median water quality estimates across all monitoring stations for a given year against the total number of cumulative restoration projects for the current and all preceding years.  Significant relationships were observed between water quality and number of projects for all project types ($\alpha$ = 0.05), although the strength of association varied.  Overall, stronger assocations with number of projects were observed for total nitrogen and relatively weaker associations were observed for chlorophyll.  Decreases in total nitrogen were most strongly associated with water infrastructure projects for nonpoint source ($F=65.5, df = 1, 23, p < 0.005$) and point source controls ($F=60.8, df = 1, 21, p < 0.005$), as expected. Habitat protection projects were also strongly associated with decreases in total nitrogen ($F=34.8, df = 1, 14, p < 0.005$).  For chlorophyll, the strongest associations were observed with habitat establishment ($F=20.8, df = 1, 35, p< 0.005$) and point source control ($F=13.7, df = 1, 22, p < 0.005$) projects.  A weak but marginally significant association was observed between chlorophyll and cumulative habitat protection projects ($F=4.6, df = 1, 14, p = 0.049$).

An obvious limitation of the above analysis is the confounding effect of almost all restoration projects increasing through time.  Although significant associations were observed with improvements in water quality and increasing cumulative number of projects, the comparisons in Figure \@ref(fig:cumprj) do not provide a means to distinguish effects of different project types.  For example, the separate effects of habitat establishment and point source projects on chlorophyll reductions cannot be separated through simple linear analyses because both increase over time, i.e., an association of chlorophyll with one project type could be an artifact of an association with another project type. Likewise, a weak assocation (e.g., habitat protection and chlorophyll) does not provide strong evidence that a particular project type is unimportant for water quality improvements.  Our formal approach that uses spatial-temporal matching between restoration projects and water quality stations is meant to overcome these challenges and results from the simple analysis above provides a basis of comparison for how our approach could lead to new insights. 

Baywide estimates of the potential effects of restoration projects using spatial-temporal matching differed depending on the year windows and number of closest restoration projects that were matched to each water quality station.  Figure \@ref(fig:prjsig) shows the estimated associations of different projects types with chlorophyll at individual stations in the left maps and the baywide aggregate associations across all stations for a given project type in the right plots. Station points in the maps correspond to an estimate for the year window and closest project type selections for each project type that were obtained through the steps in Figure \@ref(fig:statex) and eqn. \@ref(eq:wqdif).  Water quality stations outlined in black show where the estimated change is significant (i.e., the standard error lines in the botom plot of Figure \@ref(fig:statex) do not include zero, green points where chlorophyll was lower, red points where higher).  The plots on the right are based on the baywide distributions of the estimated water quality changes for all stations for the corresponding project types in the maps on the left.  The plots on the right also include statistical summaries for 1) an analysis of variance (ANOVA) F-test to compare the distribution of water quality changes between project types, 2) individual t-tests for each project type to evaluate changes that were different from zero, and 3) a multiple comparison test denoted by letters to identify which project types had changes that were different from each other. 

For site-specific estimates of water quality changes, a slight trend of longer time windows and more project matches with the number of monitoring stations that had significant changes was observed (i.e., more black circles in the maps Figure \@ref(fig:prjsig)d, compared to Figure \@ref(fig:prjsig)a).  This was particularly true for habitat protection projects where no significant associations were observed for the 5 year window, 5 closest projects combination, but twelve stations had significant assocations for the 10 year window, 10 closest projects combination. A similar trend was observed for point source control projects where more stations had more significant reductions in chlorophyll with the 10 year window, 10 closest projects.  For nonpoint source projects, the greatest number of stations (n = 13) with significant improvements in water quality was observed for the 5 year window, 10 closest projects combination.  Associations of habitat enhancement and habitat establishment projects with water quality stations were inconsistent, with some sites showing an increase or decrease that varied by the year window, closest project combinations. Spatial patterns among stations regarding associations with different project types were also not clear, although point source controls were more commonly associated with improvements in mid-bay stations (Middle Tampa Bay segment).   

The estimated baywide effects for each project type showed that point source controls were more strongly associated with reductions in chlorophyll than the other project types (Figure \@ref(fig:prjsig), right plots).  This assocation was particularly strong for the ten year window combinations (Figure \@ref(fig:prjsig)c, d), where the results suggested an overall baywide reduction in chlorophyll of aproximately 2 $\mu$g/L (based on the median change across all sites, reduction of 2.7 $\mu$g/L for 10 years, 5 closest projects and 1.6 $\mu$g/L for 10 years, 10 closest projects). Nonpoint source controls were also significantly associated with chlorophyll reducutions, but only when more projects were considered (10 closest project combinations, Figure \@ref(fig:prjsig)b, d).  Estimated reductions were not as large for nonpoint source controls compared to point source controls (reduction of 0.7 $\mu$g/L for 5 years, 10 closest projects and 0.5 $\mu$g/L for 10 years, 10 closest projects). Habitat protection projects were also significantly associated with baywide changes for all year window, closest project combinations, with the largest estimated reduction of 1$\mu$g/L for the 5 year window, 5 closest projects combination.  Habitat enhancement and establishment projects were not strongly associated with baywide changes in chlorophyll, with the exception of habitat establishment for the 10 year window, 10 closest projects combination (0.9 $\mu$g/L reduction).

The above analysis was repeated for individual bay segments to identify spatial variation in associations of restoration projects with water quality changes.  This analysis also demonstrated flexibility in how the approach can be tailored to better understand effects of restoration in different spatial contexts.  Table \@ref(tab:prjsigseg) provides similar information as the plots on the right side of Figure \@ref(fig:prjsig), where results are presented similarly but for each of four bay segments (HB: Hillsborough Bay, LTB: Lower Tampa Bay, MTB: Middle Tampa Bay, OTB: Old Tampa Bay, Figure \@ref(fig:map)) for each year window, closest projects combination. As for the baywide result, point source controls were most consistently associated wtih reductions in chlorophyll, particularly for ten year window combinations.  Nonpoint source controls were also important, altough significant assocations with chlorophyll changes were limited to the Middle and Old Tampa Bay segments. The importance of habitat protection projects for different bay segments varied by year window, closest project combinations.  Habitat establishment projects were most strongly associated with changes in each bay segment for the 10 year window, 10 closest projects combination, with the exception of Hillsborough Bay where the relationship was not significant.  Chlorophyll changes in Lower Tampa Bay were significantly associated with habitat enhancement and establishment projects for the 5 year window, 10 closest projects combination.

# Discussion

Several conclusions can be made from the results that are supported by known changes in water quality over the history of long-term monitoring in Tampa Bay.  As expected, water infrastructure projects related to point and nonpoint source controls were consistently associated with improvements in water quality.  The observed record of restoration projects included key point control efforts that occurred in the upper portion of Tampa Bay (Hillsborough Bay) that were successful in reducing nutrient loads during the first two decades of observation.  These outcomes were expected and the ability of the results to clearly demonstrate these long-term effects provided a proof of concept for the overall approach. Moreover, efforts focused on mitigating effects of nonpoint sources of pollution were more common in the latter half of record after 1990 and our results provide evidence that suggests these projects have been effective in improving water quality baywide. Nonpoint control efforts broadly described several activities that included, among others, street sweeping, education/outreach efforts, and various best management practices for stormwater, agricultural, and wetland programs.  The ability to document effects of nonpoint control efforts on water quality relative to end-of-pipe controls is challenging [@Hassett05;@Meals10] and the results suggest that our approach is capable of detecting improvements in water quality from these projects.   

Habitat restoration projects were also associated with reductions in chlorophyll, although less so than those associated with water infrastructure projects. Our categorization of habitat projects as enhancement, establishment, and protection were developed to better understand potential effects on water quality related to the type and intensity of actions for each group.  Specifically, the categories represented extremes from low to high intensity effort, where protection was low effort (e.g., direct land acquisition), establishment was high effort (e.g., mangrove/seagrass plantings, creation of oyster reefs), and enhancement was moderate effort depending on the activity (hydrologic restoration for wetlands, exotic species control).  The categorization by effort combined with the associated estimates of water quality improvements provides a coarse cost-benefit analysis.  For example, habitat protection was consistently linked to chlorophyll reductions independent of year windows and number of projects and the effort for land acquisition is minimal relative to the other habitat restoration projects.  Conversely, habitat enhancement was not strongly associated with baywide improvements in water quality and such projects may require more intensive effort. Based on these results, habitat protection may be a more cost-effective approach than habitat establishment if evaluating the effects on overall bay conditions.

Our results also provide an approach to identify an expected range of time and number of projects that are associated with potential improvements in water quality.  This information was included as an explicit component in \@ref(eq:wqdif) to quantify tradeoffs for different restoration activites based on how results varied by time and effort, similar to the categorization for habitat projects.  Water quality improvements that are observed after a short period of time since project completion and with fewer projects (e.g., 5 year window, 5 closest projects) may be more cost-effective than those where improvements are observed after longer periods of time and with more projects (e.g., 10 year window, 10 closest projects).  Given this logic, both habitat protection and point source controls seem cost-effective, whereas other projects may be less cost-effective if improvements are observed only if additional time passes or more projects are included (e.g., nonpoint source controls, habitat enhancement).  However, this approach assumes that immediate improvements with minimal effort are desirable and implicitly discounts the long-term effects that may or may not persist for a given project type. System hysteresis may indicate an initial improvement of water quality associated from a particular project, although degraded conditions may persist long-term if additional restoration projects are not pursued or underlying problems are not addressed [i.e., @Scheffer98;@Borja10].  As an example, habitat enhancement projects were associated with improvements in Lower Tampa Bay only during the five year window with ten projects; reductions in chloropyll were not shown to persist at the ten year window.

## Assumptions and limitations

There are several assumptions and limitations of our approach that affect the interpretation of the results. These assumptions and limitations are a reflection of 1) the inherent uncertainty in quantifying baywide effects of restoration projects that vary considerably in mechanisms that affect water quality through space and time, and 2) explicit construction of the approach to best account for this uncertainty.  Because we do not know the true effect of restoration projects, the results can be interpreted as worst- or best-case descriptions depending on how much actual truth is reflected in the estimates.  At worst, we provide an approach that can identify the closest restoration projects that have occurred near a water quality monitoring site and at what points in the period of observation should a potential change be expected as a result of each project.  We consider this valualbe information for managers even if there is considerable uncertainty in the estimates of change; there are currently no tools that match restoration projects to water quality records in Tampa Bay and our tool is the first do so.  At best, we provide a decision support tool that provides managers with an expectation of how water quality is expected to change as a function of types of restoration activities, how much improvement can be expected given the number of projects, and within which time frames improvement should be observed.

The value of our approach to quantify cumulative effects of restoration on water quality is likely in between the best and worst case scenarios for how much certainty is reasonably expected in the conclusions. The ability of our model to support previously and well-described changes in water quality in response to management actions (e.g., improvements from point source controls) provides a non-trivial amount of reasonable assurance in our model and that we have improved our understanding of restoration effectiveness beyond the basic information in Figure \@ref(fig:cumprj).  Operating under this assumption, an explanation of how the results could be interpreted to guide management is required to minimize extrapolation of conclusions beyond a reasonable level of confidence in what the model provides.  

As an example, Figure \@ref(fig:prjsig) suggests that point source controls were responsible for an approximate baywide reduction of 2 $\mu$g/L of chlorophyll.  These results were observed at the 10 year window and 5 (and 10) closest project combinations.  What exactly does this information suggest and what expectations can be derived regarding the likely effects of future point source control efforts? First, an inaccurate conclusion is that baywide chlorophyll would be reduced by 2 $\mu$g/L of chlorophyll after ten years if five projects are implemented in the future.  A more correct interpretation is that historically, the aggregate effect of point source control projects for a "typical" station at any point in the record and location in the bay has been a reduction of 2 $\mu$g/L after about ten years in response to ten projects, all of which were completed at different times.  This description is understandably vague, but it does provide a frame of context for an expectation relative to other types of projects, particularly in narrative terms.  For example, the aggregate effects of habitat establishment projects were most apparent for the ten year window, ten closest projects combination.  With this information, qualitative conclusions about the relative effects of point source control versus habitat establishment can be made.  That is, point source projects are "more effective" because improvements are expected with "less time" and "less effort", as applied to a "typical" water quality station that could be at any location.  Similar but alternative conclusions could be made in different spatial contexts (i.e., Table \@ref(tab:prjsigseg)).

The flexibility and simplicity of the approach to quantify associations between restoration projects and water quality was purposeful given the constraints of the data.  Although the compiled restoration databases included additional information on effort (e.g., acreage restored), these data were not consistently collected and our approach was constrained to the most basic information about each project (i.e, type, completion date, and location).  Within these constraints, the model was strictly associative and any conclusions do not provide a mechanistic explanation.  These limitations in our associative approach were apparent in some of the results.  Specifically, significant increases in chlorophyll associated with particular projects and year/site combinations were observed (e.g., Figure \@ref(fig:prjsig)d, three sites for habitat enhancement).  These trends are contrary to expectations and highlight shortcomings where the simple design did not adequately account for additional factors that were important.  Our aggregated estimates using all stations to describe a baywide effect were partly meant to reduce the influence of some of these spurious results. 

The simplicity of our approach also means that it is highly adaptable to novel contexts. A primary goal of this study was to develop a decision support tool that could be applied to other systems.  We used Tampa Bay as an example where the outcome was partially known and a rich dataset was available, thereby developing an a priori expectation of the outcome and using the data to support previous conclusions about baywide trends.  Application to additional systems would require, at minimum, water quality observations spanning multiple years and a similar dataset of relevant restoration projects.  Our categorization that described relevant water and habitat related projects was specific to Tampa Bay and our approach allows for different categories depending on the types of activities that may have occurred and the expected benefits for water quality.  Similary, the flexibility of our approach to accommodate different year windows and number of projects provides a diagnostic that is sensitive to both the restoration effort expressed in a dataset and how the potential effects could be interpreted.  Lastly, we demonstrated flexibility in the spatial context ranging from estimated changes at discrete locations to entire system-wide responses.  Although there is uncertainty associated with these interpretations (noted above), the ability to accommodate different spatial contexts means the approach can be readily applied to different systems. 

## Conclusions 

A long-term record of restoration activities and water quality data in Tampa Bay provided the foundation to develop a novel decision support tool for coastal restoration practitioners and managers. This new tool provided a 1) unique process to understand the associations between past restoration proejcts and known changes in water quality and 2) establishes an expection of water quality improvements that could result from future restoration activities contingent upon the level of investments in different activities and the required monitoring to understand downstream water quality benefits at local to watershed scales. Overall we demonstrated a baywide assocation of water quality changes to different restoration activites that varied by project type, chosen parameters to estimate the results, and the spatial context of interpretation.  The flexibility of our approach has potentially broad application and extension within the Gulf Coast restoration and management community. 

# Figures

```{r map, fig.cap = 'Water quality stations and restoration projects in the Tampa Bay area.  Water quality stations have been monitored monthly since 1974.  Locations of restoration projects represent `r nrow(restdat)` records that are generally categorized as habitat or water infrastructure projects from 1971 to present.  Bay segments as management units of interest are shown in the upper right inset. HB: Hillsborough Bay, LTB: Lower Tampa Bay, MTB: Middle Tampa Bay, OTB: Old Tampa Bay.'}
knitr::include_graphics('figs/tbrest_map.png')
```

```{r message = F, results = 'hide'}
# number of projects by year, type
toplo1 <- restdat %>% 
  left_join(reststat, by = 'id') %>% 
  group_by(date, type) %>% 
  summarise(
    cnt = n()
  ) %>% 
  ungroup %>% 
  mutate(
    type = factor(type, levels = typelev, labels = typelab)
  ) %>% 
  filter(date <= 2017)

# bar plot of project counts by year
p1 <- ggplot(toplo1, aes(x = date, y  = cnt, fill = type)) +
  geom_bar(stat ='identity', colour = 'darkgrey') +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = c(0.1, 0.65), 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) +
  ylab('Count') +
  scale_x_continuous(expand = c(0, 0)) + 
  ggtitle('(a) Counts of restoration project types over time')

# year categories 
toplo2 <- restdat %>% 
  left_join(reststat, by = 'id') %>% 
  filter(date <= 2017) %>% 
  mutate(
    type = factor(type, levels = typelev, labels = typelab),
    date_cat = cut(date, 
                   breaks = c(-Inf, 1980, 1990, 2000, 2010, Inf), 
                   labels = c('1971 - 1980', '1980 - 1990', '1990 - 2000', '2000 - 2010', '2010 - 2017'))
  )
flbound <- map_data('state', region = 'florida')

# map of projects by year categories
p2 <- ggplot() +
  geom_polygon(data = flbound, aes(x = long, y = lat, group = group), fill = '#ffffb2', alpha = 0.5) +
  geom_path(data = flbound, aes(x = long, y = lat, group = group), alpha = 0.6, size = 0.25) +
  geom_point(data = toplo2, aes(x = lon, y = lat, fill = type), colour = 'darkgrey', pch = 21, size = 1.5) + 
  coord_map(ylim = c(27.37, 28.28), xlim = c(-82.9, -81.9)) + 
  facet_wrap(~date_cat, ncol = 5, strip.position = 'bottom') + 
  scale_fill_manual(values = typecol) + 
  # ylab('') +
  theme_bw(base_family = 'serif') +
  theme(
    axis.title = element_blank(), 
    legend.position = 'none',
    strip.background = element_blank(), 
    strip.placement = 'outside'
  ) + 
  scale_x_continuous(breaks = seq(-82.7, -82.1, length = 4))+ 
  ggtitle('(b) Locations of restoration project types over time')

# combine plots
# pdf('figs/restyrs.pdf', family = 'serif', height = 5.5, width = 9)
png('figs/restyrs.png', family = 'serif', height = 5.5, width = 9, units = 'in', res = 300)
p1 + p2 + plot_layout(ncol = 1, heights = c(1.19, 1))
dev.off()
```
```{r restyrs, fig.cap = 'Counts (top) and locations (bottom) of restoration project types over time in the Tampa Bay watershed.  Restorations were categorized as water infrastructure (blue; nonpoint source controls, point source controls) and habitat (green; enhancements, establishments, protection) projects.  The compiled restoration database included records of `r nrow(restdat)` project types and locations from 1971 to 2017.'}
knitr::include_graphics('figs/restyrs.png')
```

```{r message = F, results = 'hide'}
# spatial match plot

# combine lat/lon for the plot
toplo <- wqmtch %>% 
  mutate(stat = as.character(stat)) %>% 
  left_join(wqstat, by = 'stat') %>% 
  left_join(reststat, by = 'id') %>%
  mutate(
    resgrp = factor(resgrp, levels = c('hab', 'wtr'), labels = c('Habitat', 'Water Infrastructure'))
  ) %>% 
  rename(
    `Restoration projects` = resgrp,
    `Distance (km)` = dist
  )
    
# restoration project grouping column
restall <- left_join(restdat, reststat, by = 'id') %>% 
  mutate(
    top = factor(top, levels = c('hab', 'wtr'), labels = c('Habitat', 'Water Infrastructure'))
  ) %>% 
  rename(`Restoration projects` = top)

# extent
ext <- make_bbox(wqstat$lon, wqstat$lat, f = 0.1)
map <- get_stamenmap(ext, zoom = 12, maptype = "toner-lite")
# map <- get_map(ext, zoom = 10, maptype = 'terrain', source = 'google')

# base map
pbase <- ggmap(map) +
  theme_bw(base_family = 'serif') +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = 'top'
  )

# closest and all
toplo1 <- filter(toplo, rnk %in% 1)
toplo2 <- filter(toplo, rnk %in% c(1:10))

p1 <- pbase + 
  geom_segment(data = toplo1, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1) +
  geom_point(data = restall, aes(x = lon, y = lat, fill = `Restoration projects`), size = 3, pch = 21) +
  geom_point(data = wqstat, aes(x = lon, y = lat, size = ''), pch = 21, fill = 'cyan') +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  scale_size_manual('Water quality stations', values = 4) + 
  theme(legend.position = 'none') + 
  ggtitle('Closest match by project type')

p2 <- pbase + 
  geom_segment(data = toplo2, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1) +
  geom_point(data = restall, aes(x = lon, y = lat, fill = `Restoration projects`), size = 3, pch = 21) +
  geom_point(data = wqstat, aes(x = lon, y = lat, size = ''), pch = 21, fill = 'cyan') +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  scale_size_manual('Water quality stations', values = 4) + 
  ggtitle('Closest "n" matches')
pleg <- g_legend(p2)
p2 <- p2 + theme(legend.position = 'none')

# pdf('figs/spmtch.pdf', family = 'serif', height = 6, width = 9)
png('figs/spmtch.png', family = 'serif', units ='in', res = 300, height = 6, width = 9)
grid.arrange(
  heights = c(0.1, 1),
  pleg,
  arrangeGrob(p1, p2, ncol = 2),
  ncol = 1
  )
dev.off()
```
```{r spmtch, fig.cap = 'Spatial matching of water quality stations with restoration projects. Spatial matches of each water quality station (blue dots) with habitat (solid line to grey dots) and water infrastucture (dashed line to black dots) projects are shown as the closest single match by type on the left and the "n" closest matches on the right.  The spatial matches were made for the five restoration project types within the broader habitat and water categories shown in the figure.'}
knitr::include_graphics('figs/spmtch.png')
```

```{r message = F, results = 'hide'}
ptplo <- dplyr::filter(toplo, stat %in% 7 & rnk %in% c(1:2)) %>%
  mutate(
    id = factor(id, levels = as.character(id), labels = c('Habitat 1', 'Habitat 2', 'Water 1', 'Water 2'))
  )

p1 <- ggplot(ptplo) +
  geom_segment(aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1.5) +
  geom_point(aes(x = lon.y, y = lat.y, fill = `Restoration projects`), size = 4, pch = 21) +
  geom_point(aes(x = lon.x, y = lat.x), size = 5, pch = 21, fill = 'cyan', alpha = 0.8) +
  geom_text(aes(x = lon.y, y = lat.y, label = id), family = 'serif', size = 3, vjust = c(2.5, -2, -1.4, -2)) +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  theme_minimal(base_family = 'serif') +
  theme(line = element_blank(),
        axis.title = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        legend.position = 'none'
        ) +
  scale_x_continuous(expand = c(0.02, 0.02)) +
  scale_y_continuous(expand = c(0.03, 0.03)) +
  ggtitle('(a) Spatial match')

levs <- c('Water quality', 'Habitat 1', 'Habitat 2', 'Water 1', 'Water 2')

tmdf1 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = 1996,
  `Water 2` = 1980,
  `Habitat 1` = 1986,
  `Habitat 2` = 2009
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name),
    x = factor('Water quality')
  )

tmdf2 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = c(1991, 1996, 2001),
  `Water 2` = c(1975, 1980, 1985),
  `Habitat 1` = c(1981, 1986, 1991),
  `Habitat 2` = c(2004, 2009, 2014)
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name)
  )

tmdf3 <- data.frame(
  Before = c(1974, 1981, 2004, 1991, 1975),
  After = c(2016, 1991, 2014, 2001, 1985)
  ) %>%
  mutate(
    name = factor(levs, levels = levs)
  )

tmdf4 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = c(1991, 2001),
  `Water 2` = c(1975, 1985),
  `Habitat 1` = c(1981, 1991),
  `Habitat 2` = c(2004, 2014)
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name),
    x = factor('Water quality')
  )

p2 <- ggplot(tmdf1, aes(x = name, y = value, group = name)) +
  geom_path(data = tmdf2, aes(x = name, y = value, group = name, linetype = grp, colour = grp), size = 1.5) +
  geom_segment(data = tmdf4, aes(x = x, y = value, xend = name, yend = value, linetype = grp, colour = grp), size = 1) +
  geom_segment(data = tmdf1, aes(x = x, y = value, xend = name, yend = value, linetype = grp, colour = grp), size = 0.6) +
  geom_label(data = filter(tmdf3, !name %in% 'Water quality'), aes(x = name, y = Before),
            label = 'Before', vjust = -0.4, size = 4, family = 'serif', label.padding = unit(0.1, "lines")) +
  geom_label(data = filter(tmdf3, !name %in% 'Water quality'), aes(x = name, y = After),
            label = 'After', vjust = -0.4, size = 4, family = 'serif', label.padding = unit(0.1, "lines")) +

  coord_flip() +
  geom_point(data = filter(tmdf1, !name %in% 'Water quality'), aes(fill = grp), pch = 21, size = 3) +
  scale_fill_manual(values = c('grey60', 'grey20', 'cyan')) +
  scale_colour_manual(values = c('grey60', 'grey20', 'cyan')) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid')) + 
  theme_bw(base_family = 'serif') +
  theme(line = element_blank(),
        legend.position = 'none', 
        axis.title.y = element_blank()
        ) +
  scale_y_continuous("Temporal coverage of water quality time series") +
  ggtitle('(b) Temporal match')

# pdf('figs/tmmtch.pdf', family = 'serif', height = 3, width = 8.5)
png('figs/tmmtch.png', family = 'serif', height = 3, width = 8.5, units = 'in', res = 300)
grid.arrange(p1, p2, ncol = 2, widths = c(0.25, 1))
dev.off()
```
```{r tmmtch, fig.cap = 'Temporal matching of restoration project types with time series data at a water quality station.  The restoration project locations that are spatially matched with a water quality station (a) are used to create a temporal slice of the water quality data within a window of time before and after the completion date of each restoration project (b).  Slices are based on the closest "n" restoration projects by type (n = 2 in this example) to a water quality station.  The two broad categories of habitat and water infrastructure projects are shown in the figure as an example, whereas the analysis evaluated all five restoration sub-categories.'}
knitr::include_graphics('figs/tmmtch.png')
```

```{r message = F, results = 'hide'}
# globals
sta <- 23
yrdf <- 10
mtch <- 5
jitr <- 0
bssz <- 10
txsz <- 8

# filtered wqdat by stat
wqdatsta <- wqdat %>% 
    filter(stat %in% sta)
  
# filtered wqstat by station
wqstatsta <- wqstat %>% 
    filter(stat %in% sta)

# wq stats matched to rest stats
wqmtch <- get_clo(restdat, reststat, wqstatsta, resgrp = 'type', mtch = mtch) %>% 
  mutate(
    resgrp = factor(resgrp, levels = typelev, labels = typelab)
  )

# change factor levels in restdat
restdat <- restdat %>% 
  mutate(type = factor(type, levels = typelev, labels = typelab))

# yr windows with matched rest sites
yrwin <- get_chgdf(wqdatsta, wqmtch, wqstatsta, restdat, wqvar = 'chla', yrdf = yrdf, chgout = T) 

# add one year prior to dtaft
yrwin <- yrwin %>% 
  mutate(dtaftstr = dtaft - 365)

## Map

# combine lat/lon for the plot
toplo <- wqmtch %>%
  left_join(wqstatsta, by = 'stat') %>%
  left_join(reststat, by = 'id') %>%
  rename(
    `Restoration type` = resgrp,
    `Distance (dd)` = dist
  ) %>% 
  mutate(
    lat.y = ifelse(duplicated(lat.y), jitter(lat.y, factor = jitr), lat.y),
    lon.y = ifelse(duplicated(lon.y), jitter(lon.y, factor = jitr), lon.y)
  )
  
# restoration project grouping column
restall <- left_join(restdat, reststat, by = 'id') %>% 
  mutate(type = factor(type, levels = typelev, labels = typelab))
names(restall)[names(restall) %in% 'type'] <- 'Restoration type'

# rngs
xrng <- range(c(toplo$lon.x, toplo$lon.y))
yrng <- range(c(toplo$lat.x, toplo$lat.y))

# base map
ext <- make_bbox(xrng, yrng, f = 0.2)
map <- get_stamenmap(ext, zoom = 11, maptype = "toner-lite")
pbase <- ggmap(map) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )

# base extension
pbase <- pbase +
  # geom_point(data = restall, aes(x = lon, y = lat), size = 1, pch = 21) +
  geom_segment(data = toplo, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, alpha = -`Distance (dd)`, linetype = `Restoration type`), size = 1) +
  geom_point(data = toplo, aes(x = lon.y, y = lat.y, fill = `Restoration type`), size = 5, pch = 21) +
  geom_point(data = wqstatsta, aes(x = lon, y = lat), size = 7, colour = 'tomato1') +
  scale_fill_manual(values = typecol) +
  scale_alpha(guide = F) 

# sub map
p1 <- pbase +
  scale_y_continuous(limits = yrng) +
  scale_x_continuous(limits = xrng) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(), 
    legend.position = 'none',
    legend.title = element_blank()
  ) +
  ggtitle('(a) Example station match with restoration projects')

## Time slices

# wq ts
p2 <- ggplot() + 
    geom_rect(data = yrwin, aes(xmin = dtend, xmax = date, ymin = 0, ymax = Inf, group = resgrp, fill = resgrp), alpha = 0.8) +
    geom_rect(data = yrwin, aes(xmin = dtaftstr, xmax = dtaft, ymin = 0, ymax = Inf, group = resgrp, fill = resgrp), alpha = 0.8) +
  geom_line(data = wqdatsta, aes(x = datetime, y = chla), size = 0.3, alpha = 0.7) +
  # geom_vline(data = yrwin, aes(xintercept = date, colour = resgrp)) +
  scale_fill_manual(values = typecol) +
  scale_colour_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = 7),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  scale_y_log10('log10-Chla') + 
  ggtitle('(b) Chlorophyll time slices')

## Before/after avg.

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  gather('var', 'val', bef, aft) %>% 
  mutate(var = factor(var, levels = c('bef', 'aft')))

# wq chgs bar plot
p3 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = var, y = val, fill = resgrp)) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'top', 
    legend.title = element_blank(),
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  scale_y_log10('log10-Chla') +
  ggtitle('(c) Before/after averages')

# legend
pleg <- g_legend(p3) 
p3 <- p3 + theme(legend.position = 'none')

## Before/after avg. difference

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  mutate(
    difv = aft - bef,
    xvr = 'Diff'
  )

# wq chgs bar plot
p4 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = xvr, y = difv, fill = resgrp)) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  ylab('log10-Chla difference') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  ggtitle('(d) Before/after differences')

## Average of averages

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  mutate(
    difv = aft - bef,
    xvr = 'Diff'
  ) %>% 
  group_by(resgrp) %>% 
  summarise(
    avedf = mean(difv, na.rm = T), 
    conlo = ifelse(length(na.omit(difv)) <= 1, 0, t.test(difv)$conf.int[1]),
    conhi = ifelse(length(na.omit(difv)) <= 1, 0, t.test(difv)$conf.int[2])
  )

# wq chgs bar plot
p5 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = resgrp, y = avedf, fill = resgrp)) +
  geom_errorbar(data = toplo, aes(x = resgrp, ymin = conlo, ymax = conhi), width = 0) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  ylab('log10-Chla difference, averages') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  ggtitle(expression(paste('(e) Combined estimated effects, ', delta, italic(WQ), ' in eq. (1) for each of five project types')))

# pdf('figs/statex.pdf', height = 10.25, width = 8.5, family = 'serif')
png('figs/statex.png', height = 10.25, width = 8.5, units = 'in', family = 'serif', res = 300)
wrap_plots(pleg) + {
  p1 + p2  + p3 + p4 + plot_layout(ncol = 2)} + 
  p5 +
  plot_layout(ncol = 1, heights = c(0.05, 1, 0.2))
dev.off()
```
```{r statex, fig.cap = 'Steps to estimate cumulative effects of water quality changes at a single station relative to a selected number of projects and time windows. Subplot (a) shows station 23 in Middle Tampa Bay matched to the five nearest restoration projects for each of five types.  The time slices of the water quality observations for +/- ten years before and after the completion of each project are shown in (b), ordered from near to far.  The before/after water quality averages for the slices are shown in (c) and the differences between the two are shown in (d).  Finally, the weighted averages for the five closest matches by project type are shown in (e) with 95% confidence intervals.'}
knitr::include_graphics('figs/statex.png')
```

```{r message = F, results = 'hide'}
# cumulative number of projects by year, type
restsum <- restdat %>% 
  left_join(reststat, by = 'id') %>% 
  group_by(date, type) %>% 
  summarise(
    cnt = n()
  ) %>% 
  ungroup %>% 
  # mutate(
  #   type = factor(type, levels = typelev, labels = typelab)
  # ) %>% 
  rename(yrs = date) %>% 
  arrange(type, yrs) %>% 
  group_by(type) %>% 
  mutate(cnt = cumsum(cnt))

# wq data summarized
wqsum <- wqdat %>% 
  filter(!is.na(sal)) %>% 
  mutate(
    salgrp = 1, #cut(sal, breaks = c(-Inf, 26.5, Inf), labels = c('lo', 'hi')),
    yrs = year(datetime)
  ) %>% 
  select(yrs, salgrp, chla, tn) %>% 
  gather('var', 'val', chla, tn) %>% 
  group_by(salgrp, yrs, var) %>% 
  summarise(
    medv = median(val, na.rm = T), 
    minv = ifelse(is.na(medv), NA, min(val, na.rm = T)),
    maxv = ifelse(is.na(medv), NA, max(val, na.rm = T))
  ) %>% 
  filter(!is.na(medv)) %>% 
  filter(yrs < 2018) %>% 
  ungroup 

# wq and restoration data combined, including lm estimates
toplo1 <- inner_join(restsum, wqsum, by = 'yrs') %>% 
  group_by(var, type) %>% 
  nest %>% 
  mutate(
    mod = purrr::map(data, function(x){
      lm(medv ~ cnt, data = x)
    }), 
    modsig = purrr::map(mod, function(x){
      
      fst <- summary(x)$fstatistic
      pval <- pf(fst[1], fst[2], fst[3], lower.tail = F)
      p_ast(pval)
      
    }), 
    modrsq = purrr::map(mod, function(x){
      
      round(summary(x)$r.squared, 2)
      
    })
  ) 

# pull out models for later use
toplo1mods <- toplo1 %>% select(var, type, mod)

# continue with toplo1
toplo1 <- toplo1 %>% 
  unnest(modsig, modrsq) %>% 
  unnest(data) %>%
  unite('modsta', modsig, modrsq, sep = ' ') %>% 
  mutate(
    var = factor(var, levels = c('tn', 'chla'), labels = c('Total Nitrogen', 'Chlorophyll-a'))
  )

# summary stat text for geom_label
varloc <- data.frame(
  x = c(0, 0), 
  y = c(0.17, 3), 
  var = factor(c('Total Nitrogen', 'Chlorophyll-a'), levels = c('Total Nitrogen', 'Chlorophyll-a'))
)      
toplotxt <- toplo1 %>% 
  select(type, var, modsta) %>% 
  unique %>% 
  left_join(varloc, by = 'var')

# median wq vs cumulative projects
p1 <- ggplot(toplo1, aes(x = cnt, y = medv)) + 
  geom_point(aes(fill = type, alpha = yrs, size = yrs), pch = 21, colour = 'black') + 
  geom_text(data = toplotxt, aes(x = x, y = y, label = modsta), hjust = 0) +
  facet_grid(var ~ type, scales = 'free') + 
  geom_smooth(aes(fill = type), colour = 'black', se = T, method = 'lm') + 
  scale_fill_manual("Project type", values = typecol, guide = F) +
  scale_colour_manual("Project type", values = typecol, guide = F) + 
  scale_size("Year", range = c(0.1, 5)) +
  scale_alpha("Year", range = c(0.1, 1)) + 
  theme_bw(base_family = 'serif') + 
  theme(
    legend.position = 'top', 
    strip.background = element_blank()
    ) +
  xlab('Cumulative number of projects') + 
  ylab('Median across stations')

# p2 <- ggplot(restsum, aes(x = yrs, y = cnt, colour = type, fill = type)) + 
#   geom_line(size = 2, alpha = 0.8) + 
#   geom_line(size = 1, alpha = 1) + 
#   # geom_point(pch = 21, size = 3, colour = 'black') +
#   scale_colour_manual("Project type", values = typecol) + 
#   scale_fill_manual("Project type", values = typecol) + 
#   theme_bw(base_family = 'serif') + 
#   ylab('Cumulative number of projects') +
#   theme(
#     axis.title.x = element_blank(), 
#     legend.title = element_blank(), 
#     legend.position = 'top'
#   )

# pdf('figs/cumprj.pdf', height = 4.5, width = 7.5, family = 'serif')
png('figs/cumprj.png', height = 4.5, width = 7.5, family = 'serif', units = 'in', res = 300)
# p2 + p1 + plot_layout(ncol = 1, height = c(0.8, 1))
p1
dev.off()
```
```{r cumprj, fig.cap = 'Relationships between cumulative number of restoration projects over time and water quality observations in Tampa Bay. The plot shows median total nitrogen (mg/L) and chlorophyll ($\\mu$g/L) across all monitoring stations for each year against the cumulative number of projects for all preceding years.  Points are sized and shaded by year to show the progression of water quality and number of projects over time.  Summary statistics are shown in the bottom left corner as the significance of the linear regression (stars) and R-squared value. p > 0.05 ns, p < 0.05 *, p < 0.005 **'}
knitr::include_graphics('figs/cumprj.png')
```

```{r message = F, results = 'hide'}

yrdfin <- c(5, 10)
mtchin <- c(5, 10)
locsin <- 'all'

# baywide associations
alldat <- grdavemanu %>% 
  rename(datdf = value) %>% 
  filter(yrdf %in% yrdfin & mtch %in% mtchin & locs %in% locsin) %>% 
  mutate(
    subttl = letters[1:nrow(.)], 
    subttllng = paste0('(', subttl, ') ', yrdf, ' year window, ', mtch, ' closest projects'),
    mod = purrr::map(datdf, function(datdf){

      # anova model
      mod <- aov(avedf ~ resgrp, data = datdf)
      
      return(mod)
      
    }), 
    lets = purrr::pmap(list(mod, datdf), function(mod, datdf){

      # get significance letters for multiple comparisons
      modhsd <- TukeyHSD(mod) %>% 
        .$resgrp %>% 
        data.frame
      pvals <- modhsd$p.adj
      names(pvals) <- rownames(modhsd)
      lets <- multcompLetters(pvals)
      if('Letters' %in% names(lets))
        lets <- lets$Letters
      lets <- lets %>% 
        enframe('resgrp', 'lets')
      
      # get average and max chl chng for color mapping
      datdf <- datdf %>% 
        group_by(resgrp) %>% 
        mutate(
          maxdf = 10 #max(avedf, na.rm = T)
        ) %>% 
        ungroup
      
      # join lets with max dif values for labels
      lets <- datdf %>% 
        select(resgrp, maxdf) %>% 
        unique %>% 
        mutate(resgrp = as.character(resgrp)) %>% 
        left_join(lets, by = 'resgrp')
      
      # test if df values diff from zero, by group
      difzr <- datdf %>% 
        group_by(resgrp) %>% 
        nest %>% 
        mutate(
          tst = purrr::map(data, ~ t.test(x = .$avedf)),
          pvl = purrr::map(tst, function(x){
            
            ifelse(x$p.value > 0.05, 'mean = 0', 
                   ifelse(x$statistic > 0, 'mean > 0', 'mean < 0'))
            
          }), 
          mnest = purrr::map(tst, function(x){
            x$estimate
          })
        ) %>% 
        select(resgrp, pvl, mnest) %>% 
        unnest %>% 
        mutate(resgrp = as.character(resgrp)) 
      
      # multiplecomparison letters and diff values from difzr
      lets <- lets %>% 
        left_join(difzr, by = 'resgrp') %>% 
        unite(lets, c('lets', 'pvl'), sep = ', ')
      
      return(lets)
      
    }),
    anosum = purrr::map(mod, function(mod){
      
      # anova summary stats
      modsum <- mod %>% 
        summary %>% 
        .[[1]]
        
      pval <- modsum %>% 
        .[["Pr(>F)"]] %>% 
        .[1] %>%
        p_ast(.) 
        
      fstat <- modsum %>% 
        .[['F value']] %>% 
        .[1] %>% 
        round(2)

      out <- paste0('F = ', fstat, ', p ', pval)
      
      return(out)
      
      }),
    p1plos = purrr::pmap(list(subttl, subttllng, datdf), function(subttl, subttllng, datdf){
      
      # average changes
      datdfeval <- datdf %>% 
        left_join(wqstat, by = 'stat') %>%
        rename(`Chlorophyll change` = avedf) %>% 
        mutate(resgrp = factor(resgrp, levels = typelev, labels = typelab))
      
      # significant average changes
      datdfsigs <- datdfeval %>%
        filter(inczr %in% 'sig')
      
      # map
      p1 <- ggplot() +
        geom_sf(data = tb_seg, fill = 'gray95', colour = 'gray80') + 
        geom_point(data = datdfeval, aes(x = lon, y = lat, fill = `Chlorophyll change`, size = abs(`Chlorophyll change`)), colour = 'gray80', pch = 21) +
        geom_point(data = datdfsigs, aes(x = lon, y = lat, fill = `Chlorophyll change`, size = abs(`Chlorophyll change`)), pch = 21, colour = 'black') +
        scale_fill_gradient2('Chlorophyll change (ug/L), by site', low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0, limits = c(-8.44, 10.63)) +
        facet_grid(~ resgrp, switch = 'x') +
        coord_sf(datum = NA) +
        theme_void(base_family = 'serif', base_size = 10) +
        theme(
          legend.position = 'none',
          strip.placement = 'outside',
          panel.grid.major = element_blank(), 
          panel.grid.minor = element_blank()
        ) +
        scale_size(range = c(1, 6), guide = F) +
        guides(fill = guide_colourbar(barheight = 0.5, barwidth = 6)) +
        ggtitle(subttllng)
      
      if(!'d' == subttl)
        p1 <- p1 + theme(strip.text = element_blank())
      
      return(p1)
      
    }), 
    p2plos = purrr::pmap(list(subttl, lets, datdf, anosum), function(subttl, lets, datdf, anosum){

      # get average chl chng for color mapping
      datdf <- datdf %>% 
        group_by(resgrp) %>%
        mutate(
          grpdf = mean(avedf, na.rm = T)
        ) %>%
        ungroup %>% 
        mutate(
          resgrp = factor(resgrp, levels = typelev, labels = typelab)
        )
      
      lets <- lets %>% 
        mutate(resgrp = factor(resgrp, levels = typelev, labels = typelab))

      anosum <- data.frame(anosum = anosum, y = -7.75, x = 1, stringsAsFactors = F)
      
      # distributions
      p2 <- ggplot() +
        geom_hline(yintercept = 0, linetype = 'dashed', size = 1) +
        geom_violin(data = datdf, aes(x = resgrp, y = avedf, fill = grpdf), draw_quantiles = 0.5, alpha = 0.9) +
        scale_fill_gradient2('Within-group average (ug/L), aggregated sites', low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0, limits = c(-2.66, 0.62)) +
        geom_label(data = lets, aes(x = resgrp, y = maxdf, label = lets), size = 2.5, hjust = 0.5, family = 'serif', label.size = NA) +
        theme_bw(base_family = 'serif', base_size = 9) +
        theme(
          legend.position = 'none',
          axis.title = element_blank(),
          axis.text.x = element_text(size = 8, colour = 'black'), #, vjust = -1),
          strip.background = element_blank(),
          plot.title = element_text(family = 'serif', face = 'italic')
        ) +
        scale_y_continuous(limits = c(-8, 10)) + 
        geom_label(data = anosum, aes(y = y, x = x, label = anosum), fontface = 'italic', family = 'serif', size = 3, label.size = NA) +
        scale_x_discrete('Restoration group') +
        guides(fill = guide_colourbar(barheight = 0.5, barwidth = 6)) +
        ggtitle('\n')

      if(!'d' == subttl)
        p2 <- p2 + theme(axis.text.x = element_blank())
      
      return(p2)

    })
  )

##
# legends (also use these to get color limits)

datdfeval <- alldat %>% 
  select(subttl, datdf) %>% 
  unnest %>% 
  left_join(wqstat, by = 'stat') %>%
  rename(`Chlorophyll change` = avedf)

# range(datdfeval$`Chlorophyll change`, na.rm = T)

p1leg <- ggplot() +
  geom_point(data = datdfeval, aes(x = lon, y = lat, fill = `Chlorophyll change`), pch = 21) +
  scale_fill_gradient2('\nChlorophyll change (ug/L), by site', low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0, limits = c(-8.44, 10.63)) +
  theme_void(base_family = 'serif', base_size = 10) +
  theme(
    legend.position = 'top'
  ) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 6)) 

p1leg <- g_legend(p1leg)

datdf <- alldat %>%
  select(yrdf, mtch, subttl, datdf) %>%
  unnest %>%
  group_by(yrdf, mtch, subttl, resgrp) %>%
  mutate(
    grpdf = mean(avedf, na.rm = T)
  ) %>%
  ungroup

# range(datdf$`grpdf`, na.rm = T)

p2leg <- ggplot() +
  geom_violin(data = datdf, aes(x = resgrp, y = avedf, fill = grpdf), draw_quantiles = 0.5, alpha = 0.9) +
  scale_fill_gradient2('Within-group average (ug/L), aggregated sites', low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0, limits = c(-2.66, 0.62)) +
  theme_bw(base_family = 'serif', base_size = 9) +
  theme(
    legend.position = 'top'
  ) +
  facet_grid(subttl ~ .) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 6))

p2leg <- g_legend(p2leg)

# pdf('figs/prjsig.pdf', height = 8, width = 9, family = 'serif')
png('figs/prjsig.png', height = 8, width = 9, family = 'serif', units = 'in', res = 300)
grid.arrange(
  arrangeGrob(p1leg, alldat$p1plos[[1]], alldat$p1plos[[2]], alldat$p1plos[[3]], alldat$p1plos[[4]], 
              heights = c(0.2, 1, 1, 1, 1.1), ncol = 1), 
  arrangeGrob(p2leg, alldat$p2plos[[1]], alldat$p2plos[[2]], alldat$p2plos[[3]], alldat$p2plos[[4]], 
              heights = c(0.2, 1, 1, 1, 1.1), ncol = 1,
              left = textGrob('Chlorophyll change (ug/L), by project group', rot = 90, gp = gpar(fontfamily = 'serif' , fontsize = 8))), 
  ncol = 2, widths = c(1.3, 1)
  
)
dev.off()
```
```{r prjsig, fig.cap = 'Associations of restoration projects with chlorophyll changes at all sites in Tampa Bay.  Associations were evaluated based on different year windows (5, 10) since completion of restoration projects and number of closest restoration projects (5, 10) to each monitoring station (subfigures a-d).  The left plots show the estimated changes at each site (green decreasing, red increasing) for each restoration project type, with significant changes at a site outlined in black.  The right plots show the aggregated site changes for each project type.  Overall differences were evaluated by ANOVA F-tests (bottom left corner), whereas pairwise differences between project types were evaluated by t-tests with corrected p-values for multiple comparisons.  Chlorophyll changes by project types within each subfigure that are not significantly different share a letter and significance of the within-group mean relative to zero is also shown.'}
knitr::include_graphics('figs/prjsig.png')
```

# Tables

*Table \@ref(tab:statsum): \(\#tab:statsum) Summary of total nitrogen and chlorophyll-a observations from monitoring stations in Tampa Bay.  Minimum, median, and maximum observed values for low and high salinity conditions are shown for seasonal and annual aggregations of water quality observations at all monitoring stations (See Figure \@ref(fig:map)).  Low or high salinity is based on values below or above the long-term baywide median (26.5 psu). JFM: January, February, March; AMJ: April, May, June; JAS: July, August, September; OND: October, November, December.*
```{r statsum, eval = T}
# table of wq summaries
tab <- wqdat %>%
  filter(!is.na(sal)) %>% 
  mutate(
    salgrp = cut(sal, breaks = c(-Inf, 26.5, Inf), labels = c('lo', 'hi')),
    yrs = year(datetime),
    mos = month(datetime),
    mos = factor(mos),
    mos = fct_collapse(mos, 
                        JFM = c('1', '2', '3'),
                        AMJ = c('4', '5', '6'),
                        JAS = c('7', '8', '9'),
                        OND = c('10', '11', '12')
                        ),
    yrs = cut(yrs, 
              breaks = c(1977, 1987, 1997, 2007, 2018),
              labels = c('1977-1987', '1987-1997', '1997-2007', '2007-2017')),
    mos = as.character(mos),
    yrs = as.character(yrs)
    ) %>% 
  filter(!is.na(yrs)) %>% 
  select(-datetime, -stat, -do) %>% 
  gather('var', 'val', chla, tn)

# year grouping aggregations
yragg <- tab %>% 
  select(-mos) %>% 
  group_by(salgrp, yrs, var) %>% 
  summarise(
    minv = min(val, na.rm = T),
    medv = median(val, na.rm = T), 
    maxv = max(val, na.rm = T)
  ) %>% 
  rename(
    grpagg = yrs
  )

# month grouping aggregations
moagg <- tab %>% 
  select(-yrs) %>% 
  group_by(salgrp, mos, var) %>% 
  summarise(
    minv = min(val, na.rm = T),
    medv = median(val, na.rm = T), 
    maxv = max(val, na.rm = T)
  ) %>% 
  rename(
    grpagg = mos
  )

# aggregat yr, month aggs, format for table output
totab <- yragg %>% 
  ungroup %>% 
  bind_rows(moagg) %>% 
  gather('est', 'val', minv, medv, maxv) %>% 
  mutate(
    val = round(val, 2),
    val = formatC(val, format = 'f', flag = '0', digits = 2)
    ) %>% 
  unite('colnm', var, est, sep = ', ') %>% 
  spread(colnm, val) %>% 
  mutate(grpagg = factor(grpagg, levels = c('JFM', 'AMJ', 'JAS', 'OND', '1977-1987', '1987-1997', '1997-2007', '2007-2017'))) %>% 
  select(salgrp, grpagg, `tn, minv`, `tn, medv`, `tn, maxv`, `chla, minv`, `chla, medv`, `chla, maxv`) %>% 
  arrange(salgrp, grpagg) %>% 
  mutate(salgrp = ifelse(duplicated(salgrp), '', as.character(salgrp)))

# use flextable
brd <- fp_border(color="black")
tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(salgrp = 'Salinity', grpagg = 'Time period', `tn, minv` = 'Min', `tn, medv` = 'Median', `tn, maxv` = 'Max', `chla, minv` = 'Min', `chla, medv` = 'Median', `chla, maxv` = 'Max') %>% 
  add_header(salgrp = '', grpagg = '', `tn, minv` = 'Total Nitrogen', `tn, medv` = 'Total Nitrogen', `tn, maxv` = 'Total Nitrogen', `chla, minv` = 'Chlorophyll-a', `chla, medv` = 'Chlorophyll-a', `chla, maxv` = 'Chlorophyll-a') %>% 
  merge_h(part = 'header') %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left', part = 'all')
tab
```

*Table \@ref(tab:prjsigseg): \(\#tab:prjsigseg) Associations of restoration projects with chlorophyll changes for different segments of Tampa Bay.  Associations were evaluated based on different year windows (5, 10) since completion of restoration projects and number of closest restoration projects (5, 10) to each monitoring station within each segment. Overall differences in chlorophyll changes between restoration project types by segment and year/project number combinations were evaluated by ANOVA F-tests, whereas pairwise differences between project types were evaluated by t-tests with corrected p-values for multiple comparisons.  Chlorophyll changes by project types that are not significantly different share a letter (comparisons are only valid within rows) and significance of the within-group mean relative to zero is also shown. HB: Hillsborough Bay, LTB: Lower Tampa Bay, MTB: Middle Tampa Bay, OTB: Old Tampa Bay. p > 0.05 ns, p < 0.05 \*, p < 0.005 \*\**
```{r prjsigseg, eval = T}
yrdfin <- c(5, 10)
mtchin <- c(5, 10)
locsin <- c('OTB', 'HB', 'MTB', 'LTB')

# baywide associations
alldat <- grdavemanu %>% 
  rename(datdf = value) %>% 
  filter(yrdf %in% yrdfin & mtch %in% mtchin & locs %in% locsin) %>% 
  mutate(
    subttl = letters[1:nrow(.)], 
    subttllng = paste0('(', subttl, ') ', yrdf, ' year window, ', mtch, ' closest projects'),
    mod = purrr::map(datdf, function(datdf){

      # anova model
      mod <- aov(avedf ~ resgrp, data = datdf)
      
      return(mod)
      
    }), 
    lets = purrr::pmap(list(mod, datdf), function(mod, datdf){
      
      # get significance letters for multiple comparisons
      modhsd <- TukeyHSD(mod) %>% 
        .$resgrp %>% 
        data.frame
      pvals <- modhsd$p.adj
      names(pvals) <- rownames(modhsd)
      lets <- multcompLetters(pvals)
      if('Letters' %in% names(lets))
        lets <- lets$Letters
      lets <- lets %>% 
        enframe('resgrp', 'lets')
      
      # get average and max chl chng for color mapping
      datdf <- datdf %>% 
        group_by(resgrp) %>% 
        mutate(
          maxdf = 10 #max(avedf, na.rm = T)
        ) %>% 
        ungroup
      
      # join lets with max dif values for labels
      lets <- datdf %>% 
        select(resgrp, maxdf) %>% 
        unique %>% 
        mutate(resgrp = as.character(resgrp)) %>% 
        left_join(lets, by = 'resgrp')
      
      # test if df values diff from zero, by group
      difzr <- datdf %>% 
        group_by(resgrp) %>% 
        nest %>% 
        mutate(
          tst = purrr::map(data, ~ t.test(x = .$avedf)),
          pvl = purrr::map(tst, function(x){
            
            ifelse(x$p.value > 0.05, '0', 
                   ifelse(x$statistic > 0, '> 0', '< 0'))
            
          })
        ) %>% 
        select(resgrp, pvl) %>% 
        unnest %>% 
        mutate(resgrp = as.character(resgrp)) 
      
      # multiplecomparison letters and diff values from difzr
      lets <- lets %>% 
        left_join(difzr, by = 'resgrp') %>% 
        unite(lets, c('lets', 'pvl'), sep = ', ')
      
      return(lets)
      
    }),
    anosum = purrr::map(mod, function(mod){
      
      # anova summary stats
      modsum <- mod %>% 
        summary %>% 
        .[[1]]
        
      pval <- modsum %>% 
        .[["Pr(>F)"]] %>% 
        .[1] %>%
        p_ast(.) 
        
      fstat <- modsum %>% 
        .[['F value']] %>% 
        .[1] %>% 
        round(2)

      out <- paste0('F = ', fstat, ', ', pval)
      
      return(out)
      
      })
  )

##
#

totab <- alldat %>% 
  select(yrdf, mtch, locs, lets, anosum) %>% 
  unnest(anosum) %>% 
  unnest() %>% 
  mutate(
    resgrp = factor(resgrp, levels = typelev, labels = typelab),
    yrdf = paste(yrdf, 'years'), 
    mtch = paste(mtch, 'projects')
    ) %>% 
  rename(ANOVA = anosum) %>% 
  spread(resgrp, lets) %>% 
  select(-maxdf) %>% 
  unite('yrdf_mtch', yrdf, mtch, sep = ', ') %>% 
  arrange(desc(yrdf_mtch)) %>% 
  mutate(
    yrdf_mtch = ifelse(duplicated(yrdf_mtch), '', yrdf_mtch)
  )

# use flextable
brd <- fp_border(color="black")
tab <- regulartable(totab) %>% 
  font(fontname = 'Times', part = 'all') %>% 
  fontsize(size = 12, part = 'all') %>% 
  border_remove %>%
  set_header_labels(yrdf_mtch = 'Combination', locs = 'Bay segment', ANOVA = 'ANOVA', `Habitat\nenhance` = 'Habitat\nenhance', `Habitat\nestablish` = 'Habitat\nestablish', `Habitat\nprotect` = 'Habitat\nprotect', `Nonpoint\ncontrol` = 'Nonpoint\ncontrol', `Point\ncontrol` = 'Point\ncontrol') %>%
  add_header(yrdf_mtch = '', locs = '', ANOVA = '', `Habitat\nenhance` = 'Restoration project', `Habitat\nestablish` = 'Restoration project', `Habitat\nprotect` = 'Restoration project', `Nonpoint\ncontrol` = 'Restoration project', `Point\ncontrol` = 'Restoration project') %>% 
  merge_h(part = 'header') %>%
  # add_footer(yrdf_mtch = foottxt) %>% 
  # merge_at(i = 1, j = 1:4, part = "footer") %>% 
  hline(part = 'header', border = brd) %>% 
  align(align = 'left',  part = 'all') #%>% 
  # autofit 
tab



```

# References
