---
title: "Assessment of the cumulative effects of restoration activities on water quality in Tampa Bay, Florida"
output: 
  pdf_document:
    keep_tex: true
    includes: 
      in_header: head.tex
bibliography: refs.bib
urlcolor: blue
link-citations: true
---

```{r echo = F}
# get current bib file
refs <- httr::GET('https://raw.githubusercontent.com/fawda123/refs/master/refs.bib')
refs <- rawToChar(refs$content)
writeLines(refs, con = file('refs.bib'))
```

```{r setup, echo = F, warning = F, message = F, results = 'hide'}
# figure path, chunk options
knitr::opts_chunk$set(fig.path = 'figs/', warning = F, message = F, echo = F, cache = T, dev.args = list(family = 'serif'), out.width = '100%', cache.path = 'manu_draft_cache/',
  fig.process = function(x) {
  x2 = sub('-\\d+([.][a-z]+)$', '\\1', x)
  if (file.rename(x, x2)) x2 else x
  })

# libraries
library(ggmap)
library(tidyverse)
library(geosphere)
library(stringi)
library(scales)
library(tibble)
library(vegan)
library(sf)
library(sp)
library(gridExtra)
library(ggrepel)
library(lubridate)
library(forcats)
library(Hmisc)
library(multcompView)
library(patchwork)

# functions
source('../R/funcs.R')
source('../R/get_chgdf.R')
source('../R/get_clo.R')
source('../R/get_dat.R')
source('../R/get_lik.R')

# # spatial match for figs
# mtch <- 10
# wqmtch <- get_clo(restdat, reststat, wqstat, resgrp = 'top', mtch = mtch)
# save(wqmtch, file = '../data/wqmtch.RData', compress = 'xz')

load(file = '../data/restdat.RData')
load(file = '../data/reststat.RData')
load(file = '../data/wqstat.RData')
load(file = '../data/wqdat.RData')
load(file = '../data/wqmtch.RData')

# restoration project type levels, labels and colors
typelev <- c('hab_enh', 'hab_est', 'hab_pro', 'non_src', 'pnt_src')
typelab <- c('Habitat\nenhance', 'Habitat\nestablish', 'Habitat\nprotect', 'Nonpoint\ncontrol', 'Point\ncontrol')
typecol <- c('#31a354', '#74c476' , '#c7e9c0', '#3182bd', '#9ecae1')
```

# Introduction

Despite considerable investments over the last four decades in coastal and estuarine ecosystem restoration [@Diefenderfer16] these  efforts continue to face many challenges that threaten to impede their success. In the Gulf of Mexico, chronic and discrete drivers contribute to the difficulty in restoring and managing coastal ecosystems. For example, the synergistic effects of widespread chronic coastal urbanization and climate change impacts may limit habitat management effectiveness in the future (Enwright et al. 2016). Competing management and policy directives for flood protection, national commerce and energy development complicate and prolong efforts to abate coastal hypoxia and other water quality issues (Rabotyagov et al. 2014; OTHERS). Disputes surrounding fair and equitable natural resource allocation often result in contentious implementation plans for the long-term sustainability of coastal resources (GMFMC 2017). And, discrete tropical storm (@Greening06; MORE RECENT?) and large-scale pollution events (Beyer et al. 2016) often reset, reverse or delay progress in restoring coastal ecosystems. These factors create a complex environment for successful implementation of ecosystem restoration activities along the Gulf Coast.

Notwithstanding these challenges, the difficulty in rigorously monitoring and understanding an ecosystem’s condition and restoration trajectory at various spatial and temporal scales further constrain a recognition of restoration success (Hobbs and Harris 2001). The lack of long-term environmental monitoring is a primary impediment to understanding pre- versus post- restoration change [@Schiff16] -- while also impeding the recognition of any  coastal ecosystem improvements derived from prolonged management, policy and restoration activities. Where long-term coastal monitoring programs have been implemented, a broader sense of how management, policy and restoration activities affect coastal ecosystem quality can be attained (Borja et al. 2015). Utilizing lessons-learned from environmental monitoring programs, new frameworks are starting to emerge to better understand and facilitate the implementation of coastal restoration ecology from a more informed perspective (Bayraktarov et al. 2016; @Diefenderfer16).

A very large, comprehensive and concerted effort to restore Gulf of Mexico coastal ecosystems is currently underway (GCERC 2013, 2016). Primary funding for this effort stems from the legal settlements resulting from the 2010 Deepwater Horizon oil spill. Funding sources include: early restoration investments that were made immediately following the spill, resource damage assessments resulting from the spill’s impact (NRDA, 2016), a record legal settlement of civil and criminal penalties negotiated between the responsible parties and the US government with strict US congressional oversight (RESTORE Act), and matching funds from research, monitoring and restoration practitioners worldwide. These funds, equating to >$20B US, present the Gulf of Mexico community an unprecedented opportunity to revitalize regional restoration efforts that will span multiple generations (GCERC 2013, 2016). Consequently, the restoration investments being made with these funds will be highly scrutinized. Better understanding the environmental outcomes of past investments will help identify how, where and when future resources should be invested so that the Gulf Coast community can achieve the highest of restoration success.
 
Because of the difficulties in demonstrating restoration success, new tools are needed to help guide and support the implementation of Gulf of Mexico restoration activities. Here, we present an empirical framework for evaluating the success of investments in water quality improvement activities to quantify a potential expectation for changes in water quality. The framework synthesizes monitoring data across spatiotemporal scales to demonstrate how the cumulative effects of coastal restoration activities could improve water quality in an estuary. Data on water quality and restoration projects in the Tampa Bay area (Florida, USA) were used to demonstrate application of the analysis framework. Tampa Bay is the second largest estuary in the Gulf of Mexico and has been intensively monitored since the mid-1970s. The ecological context of water quality changes in the Bay is well-described and a comprehensive history of restoration projects occurring in the watershed is available, making Tampa Bay an ideal test case for demonstrating and applying a new evaluation framework. The water quality and restoration data were evaluated to identify 1) types of restoration activities that produce the greatest improvements in water quality, and 2) over which time frames may water quality benefits be teased out of synergistic restoration acitvities.  Changes in chlorophyll-a concentrations, a proxy for negative eutrophication effects within Tampa Bay [@Greening2014], were used to develop expectations of water quality changes from restoration activities.  The final product is a decision support tool to evaluate alternative scenarios of restoration implementation strategies.

# Methods

## Study area

Tampa Bay is located on the west-central Gulf coast of Florida and its watershed is one of the most highly developed regions in Florida (\cref{fig:map}).  More than 60 percent of land within 15 km of the Bay shoreline is a mix of urban and suburban uses (SWFWMD 2011).  The Bay has been a focal point of economic activity since the 1950s and currently supports a mix of industrial, domestic, and recreational activities.  The watershed includes one of the largest phosphate production regions in the country, which is supported by port operations primarily in the northeast portion of the Bay [@Greening06].  Water quality data have been collected since the 1970s when environmental conditions were highly degraded.  Nitrogen loads into the Bay in the mid-1970s have been estimated as 8.9 x 10^6 kg year-1, most of which came from untreated wastewater effluent [@Greening06].  In addition to reduced aesthetics, environmental conditions associated with hyper-eutrophy were common and included elevated chlorophyll-a concentrations, increased occurrence of harmful algal species, low concentrations of bottom water dissolved oxygen, low water clarity, reduced seagrass coverage, and declines in fishery yields for both sport and recreational species.  Advanced wastewater treatment operations were implemented at municipal plants by the early 1980s.  These efforts were successful in reducing nutrients loads to the Bay by 90%. 

\begin{figure}
\centerline{\includegraphics[width = 0.8\textwidth]{figs/tbrest_map.pdf}}
\caption{Water quality stations and restoration projects in the Tampa Bay area.  Water quality stations have been monitored monthly since 1974.  Locations of restoration projects represent 891 records of habitat or water infrastructure projects from 1971 to present.}
\label{fig:map}
\end{figure}
 
Current water quality in Tampa Bay is dramatically improved from historical conditions.  Most notably, seagrass coverage in 2016 was reported as 16,857 hectares baywide, surpassing the restoration goal of coverage in the 1950s [@Sherwood17].  These changes have occured in parallel with reductions in nutrient loading [@Poe05;@Greening06], chlorophyll concentrations [@Wang99;@Beck15], and improvements in water clarity [@Morrison06;@Beck17c]. Most of these positive changes have resulted from management efforts to reduce point source controls on nutrient pollution in the highly developed areas of Hillsborough Bay [@Johansson91;@Johansson92]. However, the cumulative and synergistic effects of over 800 additional management activities have likely also contributed to improvements in water quality over time.  Several hundred projects from both public and private entities have been completed since the 1980s.  These projects represent numerous voluntary (e.g., coastal habitat acquisition, restoration, preservation, etc.) and compliance-driven (e.g., stormwater retrofits, process water treatment upgrades, site-level permitting, power plant scrubber upgrades, improved agricultural practices, etc.) activities. Although it is generally recognized that these projects have contributed to overall Bay improvements, the cumulative effects relative to watershed-scale management efforts are not well understood. Understanding the impacts within relevant spatial boundaries and how these projects have jointly contributed to water quality changes over time will provide an improved understanding of the link between overall estuary improvements and specific restoration activities.
 
## Data sources

In addition to legacy improvements at wastewater treatment plants, nearly 900 restoration projects have been documented in the Tampa Bay area since 1971.  Several databases were synthesized to provide a comprehensive history of projects that have occurred in Tampa Bay and its watershed.  The first dataset was obtained from the Tampa Bay Water Atlas (version 2.3, [http://maps.wateratlas.usf.edu/tampabay/](http://maps.wateratlas.usf.edu/tampabay/), @TBEP17) maintained as a joint resource by the University of South Florida and the \ac{tbep}.  This database included 253 projects from 1971 to 2007 that were primarily focused on habitat establishment, enhancement, or protection in the nearshore areas of the Bay or the larger watershed (e.g., planting of *Spartina alterniflora*, exotic vegetation control, etc.). Information on more recent projects (2008-2017) acquired from the US EPA's National Estuary Program Mapper ([https://gispub2.epa.gov/NEPmap/](https://gispub2.epa.gov/NEPmap/)) added an additional 265 projects. This database was limited to basic information, such as year of completion, geographic coordinates, general activities, and areal coverage.  The last database was obtained from the \ac{tbep} Action Plan Database Portal ([https://apdb.tbeptech.org/index.php](https://apdb.tbeptech.org/index.php)) to describe locations of broader infrastructure improvement projects and structural best management practices.  This database included 368 projects from 1992 to 2016 for county, municipal or industrial activities, such as implementation of best management practices at treatment plants, creation of stormwater retention or treatment controls, or site-specific controls of point sources. 

Both project data sources were combined to provide a single dataset describing the location, year of completion, and project classification of the restoration activity. The project classifications were described in two nested categories. The first described a high-level restration classification for each project as habitat or water infrastructure.  The second was a lower-level classification for habitat projects: enhancement, establishment, and protection; and water infrastructure projects: non-point source or point source controls.  These categories were used to provide a broad characterization of restoration activites that were considered relevant for the perceived improvements in water quality over time. The nested categories were used to develop separate models describing the likelihood of changes in water quality (described below).  The final combined dataset included 891 projects from 1971 to 2017 (\cref{fig:restyrs}).  Projects with incomplete information (i.e., missing date) were not included in the final dataset.

```{r restyrs, message = F, results = 'hide'}
# number of projects by year, type
toplo1 <- restdat %>% 
  left_join(reststat, by = 'id') %>% 
  group_by(date, type) %>% 
  summarise(
    cnt = n()
  ) %>% 
  ungroup %>% 
  mutate(
    type = factor(type, levels = typelev, labels = typelab)
  ) %>% 
  filter(date <= 2017)

# bar plot of project counts by year
p1 <- ggplot(toplo1, aes(x = date, y  = cnt, fill = type)) +
  geom_bar(stat ='identity', colour = 'darkgrey') +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif') +
  theme(
    legend.position = c(0.1, 0.65), 
    legend.title = element_blank(), 
    axis.title.x = element_blank()
  ) +
  ylab('Count') +
  scale_x_continuous(expand = c(0, 0)) + 
  ggtitle('(a) Counts of restoration project types over time')

# year categories 
toplo2 <- restdat %>% 
  left_join(reststat, by = 'id') %>% 
  filter(date <= 2017) %>% 
  mutate(
    type = factor(type, levels = typelev, labels = typelab),
    date_cat = cut(date, 
                   breaks = c(-Inf, 1980, 1990, 2000, 2010, Inf), 
                   labels = c('1971 - 1980', '1980 - 1990', '1990 - 2000', '2000 - 2010', '2010 - 2017'))
  )
flbound <- map_data('state', region = 'florida')

# map of projects by year categories
p2 <- ggplot() +
  geom_polygon(data = flbound, aes(x = long, y = lat, group = group), fill = '#ffffb2', alpha = 0.5) +
  geom_path(data = flbound, aes(x = long, y = lat, group = group), alpha = 0.6, size = 0.25) +
  geom_point(data = toplo2, aes(x = lon, y = lat, fill = type), colour = 'darkgrey', pch = 21, size = 1.5) + 
  coord_map(ylim = c(27.37, 28.28), xlim = c(-82.9, -81.9)) + 
  facet_wrap(~date_cat, ncol = 5, strip.position = 'bottom') + 
  scale_fill_manual(values = typecol) + 
  # ylab('') +
  theme_bw(base_family = 'serif') +
  theme(
    axis.title = element_blank(), 
    legend.position = 'none',
    strip.background = element_blank(), 
    strip.placement = 'outside'
  ) + 
  scale_x_continuous(breaks = seq(-82.7, -82.1, length = 4))+ 
  ggtitle('(b) Locations of restoration project types over time')

# combine plots
pdf('figs/restyrs.pdf', family = 'serif', height = 5.5, width = 9)
grid.arrange(p1, p2, ncol = 1, heights = c(1.19, 1))
dev.off()
```
 
\begin{figure}
\centerline{\includegraphics[width = \textwidth]{figs/restyrs.pdf}}
\caption{Counts (top) and locations (bottom) of restoration project types over time in the Tampa Bay watershed.  Restorations were categorized as water infrastructure (nonpoint source controls, point source controls) and habitat (enhancements, establishments, protection) projects.  The compiled restoration database included records of project types and locations from 1971 to 2017.}
\label{fig:restyrs}
\end{figure}
 
Water quality data in Tampa Bay have been consistently collected since 1974 by the Environmental Protection Commission of Hillsborough County [@TBEP17].  Data were collected monthly at forty-five stations using a water sample from mid-depth or a monitoring sonde depending on the parameter.  Monitoring stations are fixed and cover the entire bay from the uppermost mesohaline sections to the lowermost euhaline portions that have direct interaction with the Gulf of Mexico. Water samples at each station are laboratory processed immediately after collection.  Measurements at each site include temperature (C), Secchi disk depth (m), dissolved oyxgen (mg/L), conductivity ($\mu$Ohms/cm), pH, salinity (psu), turbidity (Nephalometric Turbidy Units), \ac{chla} ($\mu$g/L), total nitrogen (mg/L), and total phosphorus (mg/L).  For the models, all measurements of salinity, total nitrogen, and \ac{chla} were combined for a total of 515 monthly observations of each parameter at each station.

```{r wqsum, results = 'asis', echo = F}
# table of wq summaries
tab <- wqdat %>%
  filter(!is.na(sal)) %>% 
  mutate(
    salgrp = cut(sal, breaks = c(-Inf, 26.5, Inf), labels = c('lo', 'hi')),
    yrs = year(datetime),
    mos = month(datetime),
    mos = factor(mos),
    mos = fct_collapse(mos, 
                        JFM = c('1', '2', '3'),
                        AMJ = c('4', '5', '6'),
                        JAS = c('7', '8', '9'),
                        OND = c('10', '11', '12')
                        ),
    yrs = cut(yrs, 
              breaks = c(1977, 1987, 1997, 2007, 2018),
              labels = c('1977-1987', '1987-1997', '1997-2007', '2007-2017')),
    mos = as.character(mos),
    yrs = as.character(yrs)
    ) %>% 
  filter(!is.na(yrs)) %>% 
  select(-datetime, -stat, -do) %>% 
  gather('var', 'val', chla, tn)

# year grouping aggregations
yragg <- tab %>% 
  select(-mos) %>% 
  group_by(salgrp, yrs, var) %>% 
  summarise(
    minv = min(val, na.rm = T),
    medv = median(val, na.rm = T), 
    maxv = max(val, na.rm = T)
  ) %>% 
  rename(
    grpagg = yrs
  )

# month grouping aggregations
moagg <- tab %>% 
  select(-yrs) %>% 
  group_by(salgrp, mos, var) %>% 
  summarise(
    minv = min(val, na.rm = T),
    medv = median(val, na.rm = T), 
    maxv = max(val, na.rm = T)
  ) %>% 
  rename(
    grpagg = mos
  )

# aggregat yr, month aggs, format for table output
totab <- yragg %>% 
  ungroup %>% 
  bind_rows(moagg) %>% 
  gather('est', 'val', minv, medv, maxv) %>% 
  mutate(
    val = round(val, 2)#,
    # val = formatC(val, format = 'f', flag = '0', digits = 2)
    ) %>% 
  unite('colnm', var, est, sep = ', ') %>% 
  spread(colnm, val) %>% 
  mutate(grpagg = factor(grpagg, levels = c('JFM', 'AMJ', 'JAS', 'OND', '1977-1987', '1987-1997', '1997-2007', '2007-2017'))) %>% 
  select(salgrp, grpagg, `tn, minv`, `tn, medv`, `tn, maxv`, `chla, minv`, `chla, medv`, `chla, maxv`) %>% 
  arrange(salgrp, grpagg)

cap.val <- 'Summary of total nitrogen and chlorophyll-a observations from monitoring stations in Tampa Bay.  Minimum, median, and maximum observed values for low and high salinity conditions are shown for seasonal and annual aggregations of water quality observations at all monitoring stations (See \\cref{fig:map}).  Low or high salinity is based on values below or above 26.5 psu. JFM: January, February, March; AMJ: April, May, June; JAS: July, August, September; OND: October, November, December.'

# table, have to remove header info
out <- capture.output({latex(
  totab[, -c(1, 2)],
  file = '',
  caption.loc = 'top',
  caption = cap.val,
  rowlabel = 'Time period',
  rowname = totab$grpagg,
  rgroup = c('Low', 'High'),
  n.rgroup = c(8, 8),
  cgroup = c('Total nitrogen', 'Chlorophyll-a'),
  n.cgroup = c(3, 3),
  colheads = rep(c('Min', 'Median', 'Max'), 2),
  label = 'tab:statsum',
  col.just = rep('l', ncol(totab[, -1]))
  )})
out <- paste(out, collapse = '\n')
out <- gsub('^.*(\\\\begin\\{table.*$)', '\\1', out)
cat(out)
```

## Data synthesis and analysis framework

Combining the restoration and water quality datasets was a critical part of developing the analysis framework.  Each dataset described events or sampling activities with unique dates and locations and simple pairing of restoration projects with water quality data was impractical. To address this challenge, observations in each dataset were spatially and temporally matched using an approach designed to maximize the potential of identifying a unique effect of the restoration projects on changes in water quality.  

```{r spmtch, fig.height = 6, fig.width = 9, out.width = '\\textwidth', fig.cap = 'Spatial matching of water quality stations with restoration projects. Spatial matches of each water quality station with habitat (solid line) and water infrastucture (dashed line) projects are shown as the closest on the left and the "n" closest on the right.  The matchings were repeated for the five restoration project types within the broader habitat and water categories.'}
# spatial match plot

# combine lat/lon for the plot
toplo <- wqmtch %>% 
  mutate(stat = as.character(stat)) %>% 
  left_join(wqstat, by = 'stat') %>% 
  left_join(reststat, by = 'id') %>%
  mutate(
    resgrp = factor(resgrp, levels = c('hab', 'wtr'), labels = c('Habitat', 'Water'))
  ) %>% 
  rename(
    `Restoration projects` = resgrp,
    `Distance (km)` = dist
  )
    
# restoration project grouping column
restall <- left_join(restdat, reststat, by = 'id') %>% 
  mutate(
    top = factor(top, levels = c('hab', 'wtr'), labels = c('Habitat', 'Water'))
  ) %>% 
  rename(`Restoration projects` = top)

# extent
ext <- make_bbox(wqstat$lon, wqstat$lat, f = 0.1)
map <- get_stamenmap(ext, zoom = 12, maptype = "toner-lite")
# map <- get_map(ext, zoom = 10, maptype = 'terrain', source = 'google')

# base map
pbase <- ggmap(map) +
  theme_bw(base_family = 'serif') +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    legend.position = 'top'
  )

# closest and all
toplo1 <- filter(toplo, rnk %in% 1)
toplo2 <- filter(toplo, rnk %in% c(1:10))

p1 <- pbase + 
  geom_segment(data = toplo1, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1) +
  geom_point(data = restall, aes(x = lon, y = lat, fill = `Restoration projects`), size = 3, pch = 21) +
  geom_point(data = wqstat, aes(x = lon, y = lat, size = ''), pch = 21, fill = 'cyan') +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  scale_size_manual('Water quality stations', values = 4) + 
  theme(legend.position = 'none') + 
  ggtitle('Closest match by project type')

p2 <- pbase + 
  geom_segment(data = toplo2, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1) +
  geom_point(data = restall, aes(x = lon, y = lat, fill = `Restoration projects`), size = 3, pch = 21) +
  geom_point(data = wqstat, aes(x = lon, y = lat, size = ''), pch = 21, fill = 'cyan') +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  scale_size_manual('Water quality stations', values = 4) + 
  ggtitle('Closest "n" matches')
pleg <- g_legend(p2)
p2 <- p2 + theme(legend.position = 'none')

grid.arrange(
  heights = c(0.1, 1),
  pleg,
  arrangeGrob(p1, p2, ncol = 2),
  ncol = 1
  )
```

```{r tmmtch, out.width = '\\textwidth', fig.height = 3, fig.width = 8.5, fig.cap = 'Temporal matching of restoration project types with time series data at a water quality station.  The restoration project locations that are spatially matched with a water quality station (a) are used to create a temporal slice of the water quality data within a window of time before and after the completion date of each restoration project (b).  Slices are based on the closest "n" restoration projects by type (n = 2 in this example) to a water quality station.'}
ptplo <- dplyr::filter(toplo, stat %in% 7 & rnk %in% c(1:2)) %>%
  mutate(
    id = factor(id, levels = as.character(id), labels = c('Habitat 1', 'Habitat 2', 'Water 1', 'Water 2'))
  )

p1 <- ggplot(ptplo) +
  geom_segment(aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, linetype = `Restoration projects`, colour = `Restoration projects`), size = 1.5) +
  geom_point(aes(x = lon.y, y = lat.y, fill = `Restoration projects`), size = 4, pch = 21) +
  geom_point(aes(x = lon.x, y = lat.x), size = 5, pch = 21, fill = 'cyan', alpha = 0.8) +
  geom_text(aes(x = lon.y, y = lat.y, label = id), family = 'serif', size = 3, vjust = c(2.5, -2, -1.4, -2)) +
  scale_fill_manual(values = c( 'grey60', 'grey20')) + 
  scale_colour_manual(values = c( 'grey60', 'grey20')) + 
  theme_minimal(base_family = 'serif') +
  theme(line = element_blank(),
        axis.title = element_blank(), 
        axis.line = element_blank(),
        axis.text = element_blank(),
        legend.position = 'none'
        ) +
  scale_x_continuous(expand = c(0.02, 0.02)) +
  scale_y_continuous(expand = c(0.03, 0.03)) +
  ggtitle('(a) Spatial match')

levs <- c('Water quality', 'Habitat 1', 'Habitat 2', 'Water 1', 'Water 2')

tmdf1 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = 1996,
  `Water 2` = 1980,
  `Habitat 1` = 1986,
  `Habitat 2` = 2009
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name),
    x = factor('Water quality')
  )

tmdf2 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = c(1991, 1996, 2001),
  `Water 2` = c(1975, 1980, 1985),
  `Habitat 1` = c(1981, 1986, 1991),
  `Habitat 2` = c(2004, 2009, 2014)
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name)
  )

tmdf3 <- data.frame(
  Before = c(1974, 1981, 2004, 1991, 1975),
  After = c(2016, 1991, 2014, 2001, 1985)
  ) %>%
  mutate(
    name = factor(levs, levels = levs)
  )

tmdf4 <- list(
  `Water quality` = c(1974, 2016),
  `Water 1` = c(1991, 2001),
  `Water 2` = c(1975, 1985),
  `Habitat 1` = c(1981, 1991),
  `Habitat 2` = c(2004, 2014)
  ) %>%
  enframe %>%
  unnest %>%
  mutate(
    name = factor(name, levels = levs),
    grp = gsub(' [0-9]$', '', name),
    x = factor('Water quality')
  )

p2 <- ggplot(tmdf1, aes(x = name, y = value, group = name)) +
  geom_path(data = tmdf2, aes(x = name, y = value, group = name, linetype = grp, colour = grp), size = 1.5) +
  geom_segment(data = tmdf4, aes(x = x, y = value, xend = name, yend = value, linetype = grp, colour = grp), size = 1) +
  geom_segment(data = tmdf1, aes(x = x, y = value, xend = name, yend = value, linetype = grp, colour = grp), size = 0.6) +
  geom_label(data = filter(tmdf3, !name %in% 'Water quality'), aes(x = name, y = Before),
            label = 'Before', vjust = -0.4, size = 4, family = 'serif', label.padding = unit(0.1, "lines")) +
  geom_label(data = filter(tmdf3, !name %in% 'Water quality'), aes(x = name, y = After),
            label = 'After', vjust = -0.4, size = 4, family = 'serif', label.padding = unit(0.1, "lines")) +

  coord_flip() +
  geom_point(data = filter(tmdf1, !name %in% 'Water quality'), aes(fill = grp), pch = 21, size = 3) +
  scale_fill_manual(values = c('grey60', 'grey20', 'cyan')) +
  scale_colour_manual(values = c('grey60', 'grey20', 'cyan')) +
  scale_linetype_manual(values = c('solid', 'dashed', 'solid')) + 
  theme_bw(base_family = 'serif') +
  theme(line = element_blank(),
        legend.position = 'none', 
        axis.title.y = element_blank()
        ) +
  scale_y_continuous("Temporal coverage of water quality time series") +
  ggtitle('(b) Temporal match')

grid.arrange(p1, p2, ncol = 2, widths = c(0.25, 1))
```

The matching between the two datasets began with a spatial join where the Euclidean distances between each water quality station and each restoration project were quantified.  The spatial matches were used to create a ranking of project sites from each water quality station based on distance.  The distances were also grouped by the five restoration project types (i.e., habitat protection, non-point source control, etc.) such that the closest $n$ sites of a given project type could be identified for any water quality station (\cref{fig:spmtch}).  Temporal matching between water quality stations and restoration projects was obtained by subsetting the water quality data within a time window before and after the completion date of each spatially-matched restoration project (\cref{fig:tmmtch}).  For the closest $n$ restoration sites for each of five project types, two summarized water quality estimates were obtained to quantify a before and after effect of each project.  Time windows that overlapped the start and end date of the water quality time series were discarded.  The final two estimates of the before and after effects of the five types of restoration projects at each water quality station were based on an average of the $n$ closest restoration sites, weighted inversely by distance from the monitoring station.

Change in water quality relative to each type of restoration project was estimated as:
\begin{equation}
\delta WQ = \frac{\sum_{i = 1}^{n} \hat{wq} \in win + proj_{i, dt}}{n \cdot dist_{i \in n}} - \frac{\sum_{i = 1}^{n} \hat{wq} \in proj_{i, dt} - win}{n \cdot dist_{i \in n}}
\label{eq:wqdif}
\end{equation}
where $\delta WQ$ was the difference between the after and before averages for each of $n$ spatially  matched restoration projects.  For each $i$ of $n$ projects ($proj$), the average water quality ($\hat{wq}$) within the window ($win$) either before ($proj_{i, dt} - win$) or after ($win + proj_{i, dt}$) the completion date ($dt$) for project $i$ was summed.  The summation of water quality before and after each project was then divided by the total number of $n$ matched projects, muliplied by the distance of the projects from a water quality station ($dist_{i \in n}$). This created a weighted average of the before-after effects of each project that was inversely related to the distance from a water quality station. A weighted average by distance was used based on the assumption that restoration projects farther from a water quality station will have a weaker signal. The total change in water quality for a project type was simply the difference in weighted averages.  This process was repeated for every station and a graphical example of \cref{eq:wqdif} is shown in \cref{fig:statex}

```{r statex, results = 'hide'}
# globals
sta <- 23
yrdf <- 10
mtch <- 5
jitr <- 0
bssz <- 10
txsz <- 8

# filtered wqdat by stat
wqdatsta <- wqdat %>% 
    filter(stat %in% sta)
  
# filtered wqstat by station
wqstatsta <- wqstat %>% 
    filter(stat %in% sta)

# wq stats matched to rest stats
wqmtch <- get_clo(restdat, reststat, wqstatsta, resgrp = 'type', mtch = mtch) %>% 
  mutate(
    resgrp = factor(resgrp, levels = typelev, labels = typelab)
  )

# change factor levels in restdat
restdat <- restdat %>% 
  mutate(type = factor(type, levels = typelev, labels = typelab))

# yr windows with matched rest sites
yrwin <- get_chgdf(wqdatsta, wqmtch, wqstatsta, restdat, wqvar = 'chla', yrdf = yrdf, chgout = T) 

# add one year prior to dtaft
yrwin <- yrwin %>% 
  mutate(dtaftstr = dtaft - 365)

## Map

# combine lat/lon for the plot
toplo <- wqmtch %>%
  left_join(wqstatsta, by = 'stat') %>%
  left_join(reststat, by = 'id') %>%
  rename(
    `Restoration type` = resgrp,
    `Distance (dd)` = dist
  ) %>% 
  mutate(
    lat.y = ifelse(duplicated(lat.y), jitter(lat.y, factor = jitr), lat.y),
    lon.y = ifelse(duplicated(lon.y), jitter(lon.y, factor = jitr), lon.y)
  )
  
# restoration project grouping column
restall <- left_join(restdat, reststat, by = 'id') %>% 
  mutate(type = factor(type, levels = typelev, labels = typelab))
names(restall)[names(restall) %in% 'type'] <- 'Restoration type'

# rngs
xrng <- range(c(toplo$lon.x, toplo$lon.y))
yrng <- range(c(toplo$lat.x, toplo$lat.y))

# base map
ext <- make_bbox(xrng, yrng, f = 0.2)
map <- get_stamenmap(ext, zoom = 11, maptype = "toner-lite")
pbase <- ggmap(map) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )

# base extension
pbase <- pbase +
  # geom_point(data = restall, aes(x = lon, y = lat), size = 1, pch = 21) +
  geom_segment(data = toplo, aes(x = lon.x, y = lat.x, xend = lon.y, yend = lat.y, alpha = -`Distance (dd)`, linetype = `Restoration type`), size = 1) +
  geom_point(data = toplo, aes(x = lon.y, y = lat.y, fill = `Restoration type`), size = 5, pch = 21) +
  geom_point(data = wqstatsta, aes(x = lon, y = lat), size = 7, colour = 'tomato1') +
  scale_fill_manual(values = typecol) +
  scale_alpha(guide = F) 

# sub map
p1 <- pbase +
  scale_y_continuous(limits = yrng) +
  scale_x_continuous(limits = xrng) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank(), 
    legend.position = 'none',
    legend.title = element_blank()
  ) +
  ggtitle('(a) Example station match with restoration projects')

## Time slices

# wq ts
p2 <- ggplot() + 
    geom_rect(data = yrwin, aes(xmin = dtend, xmax = date, ymin = 0, ymax = Inf, group = resgrp, fill = resgrp), alpha = 0.8) +
    geom_rect(data = yrwin, aes(xmin = dtaftstr, xmax = dtaft, ymin = 0, ymax = Inf, group = resgrp, fill = resgrp), alpha = 0.8) +
  geom_line(data = wqdatsta, aes(x = datetime, y = chla), size = 0.3, alpha = 0.7) +
  # geom_vline(data = yrwin, aes(xintercept = date, colour = resgrp)) +
  scale_fill_manual(values = typecol) +
  scale_colour_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = 7),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  scale_y_log10('log10-Chla') + 
  ggtitle('(b) Chlorophyll time slices')

## Before/after avg.

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  gather('var', 'val', bef, aft) %>% 
  mutate(var = factor(var, levels = c('bef', 'aft')))

# wq chgs bar plot
p3 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = var, y = val, fill = resgrp)) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'top', 
    legend.title = element_blank(),
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  scale_y_log10('log10-Chla') +
  ggtitle('(c) Before/after averages')

# legend
pleg <- g_legend(p3) 
p3 <- p3 + theme(legend.position = 'none')

## Before/after avg. difference

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  mutate(
    difv = aft - bef,
    xvr = 'Diff'
  )

# wq chgs bar plot
p4 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = xvr, y = difv, fill = resgrp)) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  facet_grid(rnk ~ resgrp) + 
  ylab('log10-Chla difference') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  ggtitle('(d) Before/after differences')

## Average of averages

# to plot
toplo <- yrwin %>% 
  select(rnk, resgrp, wts, bef, aft) %>% 
  mutate(
    difv = aft - bef,
    xvr = 'Diff'
  ) %>% 
  group_by(resgrp) %>% 
  summarise(
    avedf = mean(difv, na.rm = T), 
    conlo = ifelse(length(na.omit(difv)) <= 1, 0, t.test(difv)$conf.int[1]),
    conhi = ifelse(length(na.omit(difv)) <= 1, 0, t.test(difv)$conf.int[2])
  )

# wq chgs bar plot
p5 <- ggplot() + 
  geom_bar(data = toplo, stat = 'identity', aes(x = resgrp, y = avedf, fill = resgrp)) +
  geom_errorbar(data = toplo, aes(x = resgrp, ymin = conlo, ymax = conhi), width = 0) +
  scale_fill_manual(values = typecol) +
  theme_bw(base_family = 'serif', base_size = bssz) +
  theme(
    axis.title.x = element_blank(), 
    legend.position = 'none', 
    panel.border = element_rect(fill = NA),
    strip.background = element_blank(), 
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(), 
    axis.text.y = element_text(size = txsz),
    axis.text.x = element_text(size = txsz),
    panel.spacing = grid::unit(0, "lines")
  ) +
  ylab('log10-Chla difference, averages') +
  geom_hline(yintercept = 0, linetype = 'dotted') +
  ggtitle(expression(paste('(e) Combined estimated effects, ', delta, italic(WQ), ' in eq. (1) for each of five project types')))

pdf('figs/statex.pdf', height = 10.25, width = 8.5, family = 'serif')
# png('figs/statex.png', height = 10.25, width = 8.5, units = 'in', family = 'serif', res = 300)
wrap_plots(pleg) + {
  p1 + p2  + p3 + p4 + plot_layout(ncol = 2)} + 
  p5 +
  plot_layout(ncol = 1, heights = c(0.05, 1, 0.2))
dev.off()
```

\begin{figure}
\centerline{\includegraphics[width = 0.95\textwidth]{figs/statex.pdf}}
\caption{Steps to estimate cumulative effects of water quality changes at a single station relative to a selected number of projects and time windows. Subplot (a) shows station 23 in Middle Tampa Bay matched to the five nearest restoration projects for each of five types.  The time slices of the water quality observations for +/- ten years before and after the completion of each project are shown in (b), ordered from near to far.  The before/after water quality averages for the slices are shown in (c) and the differences between the two are shown in (d).  Finally, the weighted averages for the five closest matches by project type are shown in (e) with 95\% confidence intervals. }
\label{fig:statex}
\end{figure}

The combined water quality and restoration data were used as input for developing the models. Two parameters in \cref{eq:wqdif} affected the synthesis of the datasets which directly controlled the ability to characterize associations of each restoration project type with water quality changes, 1) $n$, the number of spatially-matched restoration projects used to average the cumulative effect of each project type, and 2) $win$, the time windows before and after a project completion date that were used to subset each water quality time series.  Identifying the two values that maximized the difference between before and after water quality measurements was necessary to quantify how many projects induced a change in water quality, the time within which a change is expected, and the magnitude of a change differed between project types. Moreover, two additional factors were also considered that defined the data used as input in \cref{eq:wqdif}, 1) the total length of the water quality time series, and 2) the spatial boundaries of the water quality stations.  We evaluated the effects of the length of the time series (e.g., 1974 to 2017, 1974 to 1994, 1994 to 2017) and the spatial extent (e.g., whole bay or separate bay segments) to develop a more comprehensive assessment of the relative associations of each restoration project type with changes in water quality.  This approach was used given the uneven distribution of restoration projects in space and time balanced with the known changes in water quality in different segments of the Bay.

# Results

## Initial Data Summaries

### Chronology of Restoration Activities
Figure showing restoration types through time.

### Observed Water Quality Conditions
Table showing seasonal 

## Assocations of restoration projects with water quality changes

A figure showing estimated changes across all sites 5, 10 yr windows, 5, 10 projects, maps and boxplots like ind_eval, repeat for individual segments but maybe as table? 
```{r}
yrdfin <- c(5, 10)
mtchin <- c(5, 10)
locsin <- 'all'

# baywide associations
alldat <- grdavemanu %>% 
  rename(datdf = value) %>% 
  filter(yrdf %in% yrdfin & mtch %in% mtchin & locs %in% locsin) %>% 
  mutate(
    subttl = letters[1:nrow(.)], 
    subttllng = paste0('(', subttl, ') ', yrdf, ' year window, ', mtch, ' closest projects'),
    mod = map(datdf, function(datdf){

      # anova model
      mod <- aov(avedf ~ resgrp, data = datdf)
      
      return(mod)
      
    }), 
    lets = pmap(list(mod, datdf), function(mod, datdf){
      
      # get significance letters for multiple comparisons
      modhsd <- TukeyHSD(mod) %>% 
        .$resgrp %>% 
        data.frame
      pvals <- modhsd$p.adj
      names(pvals) <- rownames(modhsd)
      lets <- multcompLetters(pvals)
      if('Letters' %in% names(lets))
        lets <- lets$Letters
      lets <- lets %>% 
        enframe('resgrp', 'lets')
      
      # get average and max chl chng for color mapping
      datdf <- datdf %>% 
        group_by(resgrp) %>% 
        mutate(
          maxdf = 10 #max(avedf, na.rm = T)
        ) %>% 
        ungroup
      
      # join lets with max dif values for labels
      lets <- datdf %>% 
        select(resgrp, maxdf) %>% 
        unique %>% 
        mutate(resgrp = as.character(resgrp)) %>% 
        left_join(lets, by = 'resgrp')
      
      # test if df values diff from zero, by group
      difzr <- datdf %>% 
        group_by(resgrp) %>% 
        nest %>% 
        mutate(
          tst = map(data, ~ t.test(x = .$avedf)),
          pvl = map(tst, function(x){
            
            ifelse(x$p.value > 0.05, 'mean = 0', 
                   ifelse(x$statistic > 0, 'mean > 0', 'mean < 0'))
            
          })
        ) %>% 
        select(resgrp, pvl) %>% 
        unnest %>% 
        mutate(resgrp = as.character(resgrp)) 
      
      # multiplecomparison letters and diff values from difzr
      lets <- lets %>% 
        left_join(difzr, by = 'resgrp') %>% 
        unite(lets, c('lets', 'pvl'), sep = ', ')
      
      return(lets)
      
    }),
    anosum = map(mod, function(mod){
      
      # anova summary stats
      modsum <- mod %>% 
        summary %>% 
        .[[1]]
        
      pval <- modsum %>% 
        .[["Pr(>F)"]] %>% 
        .[1] %>%
        round(2) 
        
      fstat <- modsum %>% 
        .[['F value']] %>% 
        .[1] %>% 
        round(2)

      out <- paste0('F = ', fstat, ', p = ', pval)
      
      return(out)
      
      })
  )

# site changes by location with sig vals

# plot title
allttls <- alldat %>% 
  select(yrdf, mtch, subttl, subttllng)
  

# average changes
datdfeval <- alldat %>% 
  select(yrdf, mtch, subttl, subttllng, datdf) %>% 
  unnest %>% 
  left_join(wqstat, by = 'stat') %>%
  rename(`Chlorophyll change` = avedf)

# significant average changes
datdfsigs <- datdfeval %>%
  filter(inczr %in% 'sig')

# map
p1 <- ggplot() +
  geom_sf(data = tb_seg, fill = 'gray95', colour = 'gray70') + 
  geom_point(data = datdfeval, aes(x = lon, y = lat, fill = `Chlorophyll change`, size = abs(`Chlorophyll change`)), colour = 'lightgrey', pch = 21) +
  geom_point(data = datdfsigs, aes(x = lon, y = lat, fill = `Chlorophyll change`, size = abs(`Chlorophyll change`)), pch = 21, colour = 'black') +
  # geom_point(data = datdfsigs, aes(x = lon, y = lat, size = abs(`Chlorophyll change`)), pch = 21, colour = 'black', fill = NA) +
  scale_fill_gradient2(low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0) +
  facet_grid(subttl ~ resgrp, switch = 'x') +
  coord_sf(datum = NA) +
  theme_void(base_family = 'serif', base_size = 10) +
  theme(
    legend.position = 'top',
    strip.placement = 'outside',
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank()
  ) +
  scale_size(range = c(1, 9), guide = F) +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 10)) +
  ggtitle(subttl)

# get average chl chng for color mapping
datdf <- alldat %>% 
  select(yrdf, mtch, subttl, datdf) %>% 
  unnest %>% 
  group_by(yrdf, mtch, subttl, resgrp) %>% 
  mutate(
    grpdf = mean(avedf, na.rm = T)
  ) %>% 
  ungroup

# multiplecomparison letters and diff values from difzr
lets <- alldat %>% 
  select(yrdf, mtch, subttl, lets) %>% 
  unnest 

# anova sum stats
anosum <- alldat %>% 
  select(yrdf, mtch, subttl, anosum) %>% 
  unnest(anosum) %>% 
  unique
  
# map
p2 <- ggplot() + 
  geom_hline(yintercept = 0, linetype = 'dashed', size = 1) +
  geom_boxplot(data = datdf, aes(x = resgrp, y = avedf, fill = grpdf)) +
  scale_fill_gradient2('Within-group average', low = 'lightgreen', mid = 'white',  high = 'tomato1', midpoint = 0) + 
  geom_label(data = lets, aes(x = resgrp, y = maxdf, label = lets), hjust = 0.5, family = 'serif', label.size = NA) +
  geom_label(data = anosum, aes(y = -8, x = 1, label = anosum), fontface = 'italic', family = 'serif', label.size = NA) +
  theme_bw(base_family = 'serif', base_size = 9) +
  theme(
    legend.position = 'top', 
    axis.title.x = element_blank(), 
    strip.background = element_blank()
  ) +
  facet_grid(subttl~.) +
  scale_y_continuous('Chlorophyll change') +
  scale_x_discrete('Restoration group') +
  guides(fill = guide_colourbar(barheight = 0.5, barwidth = 6)) 

# grid.arrange(p1, p2, ncol = 2)
# 
# p1 + p2 + plot_layout(ncol = 1)
```


# Discussion
A long-term record of restoration activities and water quality data in Tampa Bay provided the foundation to develop a novel decision support tool for coastal restoration practitioners and  managers. This new tool provides an improved process to understand the expected water quality improvements that could result from future restoration activities contingent upon the level of cumulative investments made toward divergent activities and the required monitoring to understand downstream water quality benefits at local to watershed-wide scales. This tool has broad application and extention within the Gulf Coast restoration and management community. However, several reservations on its appliction were discovered.



* 2004-2017, non-point source and habitat protection appears to have the largest effect on chlorophyll-a levels. This effect is not clear until after 5 years of monitoring and with the evaluation of multiple projects. 
When fewer restoration activities were taking place in the Bay (i.e. 94-04) a greater monitoring time frame was necessary to identify the benefits of restoration activities (>5 years).

* From 1974 - 1994, chlorophyll changes were most distinct in relation to water infrastructure projects, particularly for low salinity regions in the bay. The effect was more apparent with increasing time from the completion of a project and with evaluation of multiple projects. Habitat projects did not have a noticeable effect although, these were limited to later in the time period.

* It is inherently difficult to determine any downstream water quality benefits from enhancement no matter how many sites or years. Enhancement is primarily activities such as invasive species removal which is not done with the primary goal of improving water quality. 

* How can this be used to guide coastal wq management in the Gulf? 
     * Demonstrate the benefit of Long Term monitoring
     
* How can this be used to inform or prioritize restoration activities in the Gulf?

* What are the limitations of our analysis?

* How can the analysis be applied in other locations?


# References

