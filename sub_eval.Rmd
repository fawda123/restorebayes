---
output: 
  html_document:
    code_folding: hide
self_contained: yes
runtime: shiny
---
  
# Simple model

```{r globals, echo = T, message = F, warning = F}
knitr::opts_chunk$set(message = F, warning = F)

library(tidyverse)
library(ggmap)
library(lubridate)
library(geosphere)
library(stringi)
library(tibble)
library(bnlearn)
library(scales)
library(shiny)
library(sf)
library(sp)

data(restdat)
data(reststat)
data(wqdat)
data(wqstat)

# source R files
source('R/get_chg.R')
source('R/get_clo.R')
source('R/get_cdt.R')
source('R/get_brk.R')
source('R/get_fin.R')
source('R/get_all.R')
source('R/rnd_dat.R')

# globals
mtch <- 2
yrdf <- 5
resgrp <- 'top' 
qts <- c(0.5)
lbs <- c('lo', 'hi')

# base map
ext <- make_bbox(reststat$lon, reststat$lat, f = 0.1)
map <- get_stamenmap(ext, zoom = 10, maptype = "toner-lite")
pbase <- ggmap(map) +
  theme_bw() +
  theme(
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  )
```

```{r}
numericInput("yrdf", "Choose year diff:", 5)
numericInput("mtch", "Choose number of restration matches:", 2)
```

## Pre-1994 data

```{r fig.height = 4, fig.width = 8, eval = T}
# get sub data, restoration sites
restdat_sub <- restdat %>% 
  filter(date < 1994)
reststat_sub <- reststat %>% 
  filter(id %in% restdat_sub$id)

# get conditional probability tables

## Distance to restoration sites
wqmtch <- get_clo(restdat_sub, reststat_sub, wqstat, resgrp = resgrp, mtch = mtch)

## Summarizing effects of restoration projects on salinity
sachg <- get_chg(wqdat, wqmtch, statdat, restdat, wqvar = 'sal', yrdf = yrdf) %>% 
  rename(saval = cval)

## Summarizing effects of restoration projects on chl
chchg <- get_chg(wqdat, wqmtch, statdat, restdat, wqvar = 'chla', yrdf = yrdf) %>% 
  rename(chval = cval)

# combine all using a super simple approach
cdat_pre <- sachg %>% 
  left_join(chchg, by = c('stat', 'hab', 'wtr')) %>% 
  mutate(
    salev = cut(saval, breaks = c(-Inf, quantile(saval, qts, na.rm = T), Inf), labels = lbs),
    chlev = cut(chval, breaks = c(-Inf, quantile(chval, qts, na.rm = T), Inf), labels = lbs)
  ) %>% 
  # dplyr::select(-saval, -nival, -chval, -stat) %>% 
  mutate_if(is.character, factor) %>% 
  data.frame
```


```{r}
cdat_pre_mod <- cdat_pre %>% 
  select_if(is.factor) %>% 
  na.omit %>% 
  data.frame

# create Network
net <- model2network("[hab][wtr][salev|hab:wtr][chlev|hab:wtr:salev]")
plot(net)

#Creating CPTs from data
fittedBN <- bn.fit(net, data = cdat_pre_mod)
```

```{r, fig.height = 3, fig.width = 4}
# get conditional probabilities of lo/md/hi chl for bef/aft of each project type
ests <- cdat_pre_mod %>% 
  dplyr::select(-salev) %>% 
  mutate_if(is.factor, as.character) %>% 
  gather('project', 'event', -chlev) %>% 
  unique %>% 
  mutate(est = NA)

for(i in 1:nrow(ests)){
  
  toest <- ests[i, ]
  est <- paste0('cpquery(fittedBN, event = (chlev == toest$chlev), evidence = (', toest$project, ' == "', toest$event, '"))')
  est <- eval(parse(text = est))
  ests[i, 'est'] <- est
  
}

# format for plot
ests <- ests %>% 
  mutate(event = gsub('^wtr\\_|^hab\\_', '', event)) %>% 
  mutate(chlev = factor(chlev, levels = lbs)) %>% 
  spread(event, est) %>% 
  mutate(
    chg = 100 * (aft - bef),
    chg = round(chg, 1)
    )

ggplot(ests, aes(x = chlev, y = project, fill = chg)) +
  geom_tile(colour = 'black') +
  geom_text(aes(label = chg, size = abs(chg))) +
  scale_size(guide = F) +
  theme_bw(base_family = 'serif') +
  scale_x_discrete('Chlorophyll', expand = c(0, 0)) + 
  scale_y_discrete('Restoration project', expand = c(0, 0)) +
  scale_fill_gradient2('% change', low = muted("red"), mid = "white", high = muted("blue"), midpoint = 0)
```
